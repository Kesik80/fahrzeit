<!--
–∑–∞–∫–æ–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ         //.sort()                                   // –∫—Ä–∞—Å–æ—Ç–∞: –ø–æ –∞–ª—Ñ–∞–≤–∏—Ç—É
–ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø:
- —É–±—Ä–∞–Ω –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π id="ghToken" (–∑–∞–º–µ–Ω—ë–Ω –Ω–∞ ghTokenInp) ‚Äî –∫—Ä—ç—à –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
- –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∞ stations.js —Å GitHub –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
- –∏—Å–ø—Ä–∞–≤–ª–µ–Ω –Ω–µ–∑–∞–∫—Ä—ã—Ç—ã–π <div> –≤ –º–æ–¥–∞–ª–∫–µ GitHub
- –∫–Ω–æ–ø–∫–∞ ‚¨ÜÔ∏è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
-->
<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>–†–µ–¥–∞–∫—Ç–æ—Ä –≥—Ä—É–ø–ø –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç</title>
<style>
  *{box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif}
  body{margin:0;padding:.4rem 4px 60px;background:#f4f4f4;font-size:1.05rem;display:flex;flex-direction:column;min-height:100vh}
  h1{font-size:1.3rem;margin:.4rem 0;text-align:center}
  #cards{flex:1 1 auto;margin-bottom:.4rem}
  .card{background:#fff;border-radius:6px;padding:.4rem 2rem .4rem .5rem;margin-bottom:.4rem;box-shadow:0 1px 3px rgba(0,0,0,.1);position:relative;display:flex;align-items:center;gap:.4rem}
  .card-title{flex:1 1 0;font-weight:bold;word-break:break-word;cursor:pointer;padding:.2rem .3rem;border:1px solid transparent;border-radius:4px}
  .card-title:hover{border-color:#bbb}
  .card-title input{width:100%;font-size:1rem;padding:.2rem;border:1px solid #007bff;border-radius:4px}
  .card-coord{flex:0 0 45%}
  .card-coord input{width:100%;padding:.3rem;font-size:1rem;border:1px solid #bbb;border-radius:4px}
  .delX{position:absolute;top:.25rem;right:.4rem;font-size:.95rem;font-weight:700;color:#dc3545;cursor:pointer;line-height:1}
  .delX:hover{color:#a71d2a}
  textarea{width:100%;min-height:400px;font-size:.95rem;font-family:monospace;padding:.4rem;border:1px solid #bbb;border-radius:4px;resize:vertical}
  .rawBlock{margin:.5rem 0}
  .bottomBar{position:fixed;left:0;right:0;bottom:0;display:flex;height:52px;background:#fff;border-top:1px solid #ccc}
  .bottomBar button{flex:1 1 20%;border:none;background:#fff;font-size:1.5rem;cursor:pointer;padding:0}
  .bottomBar button:hover{background:#f0f0f0}
  #fileInput{display:none}
  #groupSel{width:100%;margin-bottom:.5rem;padding:.4rem;font-size:1rem;border:1px solid #bbb;border-radius:4px}
  .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:999;align-items:flex-start;justify-content:center;padding-top:15vh}
  .modal-content{background:#fff;width:86%;max-width:320px;border-radius:8px;padding:1rem .8rem;text-align:center}
  .modal-content h3{margin:.3rem 0 .8rem;font-size:1.15rem}
  .modal-content input,.modal-content select{width:100%;margin:.4rem 0;padding:.5rem;font-size:1rem;border:1px solid #bbb;border-radius:4px}
  .modal-buttons{display:flex;gap:.5rem;margin-top:.6rem}
  .modal-buttons button{flex:1;padding:.5rem;font-size:1rem;border:none;border-radius:5px;cursor:pointer}
  .add-confirm{background:#007bff;color:#fff}
  .add-cancel{background:#6c757d;color:#fff}
  #msgModal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:9999;align-items:flex-start;justify-content:center;padding-top:15vh}
  #msgContent{background:#fff;width:86%;max-width:320px;border-radius:8px;padding:1rem;text-align:center;font-size:1.1rem}
  #addRiderBtn{font-size:1.2rem;padding:0 .4rem;margin-left:4px;border:1px solid #bbb;border-radius:4px;background:#fff;cursor:pointer}
  #addRiderBtn:hover{background:#f0f0f0}
  #ghUploadBtn:disabled{opacity:.4;cursor:not-allowed}
  #loadStatus{font-size:.75rem;text-align:center;color:#666;padding:.2rem 4px;background:#fff;border-bottom:1px solid #eee}
  #loadStatus.ok{color:#28a745}
  #loadStatus.err{color:#dc3545}
  #loadStatus.loading{color:#007bff}
</style>
</head>
<body>

<h1>–†–µ–¥–∞–∫—Ç–æ—Ä –≥—Ä—É–ø–ø –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç</h1>
<div id="loadStatus" class="loading">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ stations.js —Å GitHub‚Ä¶</div>

<select id="groupSel">
  <option value="defaultCoords">üë§ defaultCoords</option>
  <option value="stations">üöâ stations</option>
  <option value="travelTimes">‚è± travelTimes</option>
  <option value="treffpunkt">üìç treffpunkt</option>
  <option value="trefftravelTimes">‚è±üìç trefftravelTimes</option>
  <option value="participantOrders">üî¢ participantOrders</option>
</select>

<div id="cards"></div>
<div class="rawBlock"><textarea id="rawJson"></textarea></div>

<div class="bottomBar">
  <button id="loadBtn"     title="–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª">üìÇ</button>
  <button id="copyBtn"     title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å">üìã</button>
  <button id="addBtn"      title="–î–æ–±–∞–≤–∏—Ç—å">‚ûï</button>
  <button id="saveBtn"     title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ">üíæ</button>
  <button id="applyRaw"    title="–ü—Ä–∏–º–µ–Ω–∏—Ç—å JSON">‚úîÔ∏è</button>
  <button id="ghUploadBtn" title="–ó–∞–≥—Ä—É–∑–∏—Ç—å stations.js –Ω–∞ GitHub" disabled>‚¨ÜÔ∏è</button>
</div>

<input type="file" id="fileInput">

<!-- –º–æ–¥–∞–ª–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ—á–∫–∏ -->
<div id="addModal" class="modal">
  <div class="modal-content">
    <h3 id="addModalTitle">–ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å</h3>
    <select id="modalGroupSel">
      <option value="defaultCoords">üë§ defaultCoords</option>
      <option value="stations">üöâ stations</option>
      <option value="treffpunkt">üìç treffpunkt</option>
      <option value="travelTimes">‚è± travelTimes (–∫–ª—é—á: A-B)</option>
      <option value="trefftravelTimes">‚è±üìç trefftravelTimes (–∫–ª—é—á: –ü—É–Ω–∫—Ç-–ò–º—è)</option>
    </select>
    <input id="newName" type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ / –∫–ª—é—á">
    <input id="newCoord" type="text" placeholder="–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã (lat,lng) –∏–ª–∏ –≤—Ä–µ–º—è (–º–∏–Ω)">
    <div class="modal-buttons">
      <button id="addConfirm" class="add-confirm">–î–æ–±–∞–≤–∏—Ç—å</button>
      <button id="addCancel"  class="add-cancel">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>
</div>

<!-- –º–æ–¥–∞–ª–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ GitHub -->
<div id="ghModal" class="modal">
  <div class="modal-content">
    <h3>Upload to GitHub</h3>
    <input id="ghTokenInp" type="password" placeholder="GitHub token (classic)" autocomplete="off">

    <!-- 1. –û—Ç–ø—Ä–∞–≤–∫–∞ stations.js -->
    <div style="margin-bottom:1rem">
      <div class="modal-buttons">
        <button id="ghSendStationsBtn" class="add-confirm">‚¨ÜÔ∏è stations.js</button>
      </div>
    </div>

    <!-- 2. –û—Ç–ø—Ä–∞–≤–∫–∞ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ -->
    <hr style="margin:.8rem 0">
    <div style="font-weight:bold;margin-bottom:.4rem">–ó–∞–≥—Ä—É–∑–∏—Ç—å –¥—Ä—É–≥–æ–π —Ñ–∞–π–ª</div>
    <input id="ghAnyFile" type="file" style="margin-bottom:.5rem">
    <input id="ghAnyName" type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–∞ GitHub (–Ω–∞–ø—Ä–∏–º–µ—Ä data.json)">
    <div class="modal-buttons">
      <button id="ghSendAnyBtn" class="add-confirm">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      <button id="ghCancelBtn"  class="add-cancel">–û—Ç–º–µ–Ω–∞</button>
    </div>

  </div>
</div>

<!-- —Ç–æ—Å—Ç -->
<div id="msgModal" class="modal">
  <div id="msgContent">–°–æ–æ–±—â–µ–Ω–∏–µ</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<script>
// ==========  –ö–û–ù–°–¢–ê–ù–¢–´ GITHUB  ==========
const GH_OWNER = 'Kesik80';
const GH_REPO  = 'fahrzeit';
const GH_FILE  = 'stations.js';
// RAW URL –¥–ª—è —á—Ç–µ–Ω–∏—è –±–µ–∑ —Ç–æ–∫–µ–Ω–∞
const GH_RAW_URL = `https://raw.githubusercontent.com/${GH_OWNER}/${GH_REPO}/main/${GH_FILE}`;

// ==========  –î–ê–ù–ù–´–ï (–ø—É—Å—Ç—ã–µ –¥–æ –∑–∞–≥—Ä—É–∑–∫–∏)  ==========
let data = {
  defaultCoords: {},
  stations: {}
};
const DEFAULT_TRAVEL_TIME = 5;
let travelTimes       = {};
let participantOrders = {};
let treffpunkt        = {};
let trefftravelTimes  = {};

// ==========  –ó–ê–ì–†–£–ó–ö–ê stations.js –° GITHUB –ü–†–ò –°–¢–ê–†–¢–ï  ==========
async function loadFromGitHub() {
  const status = document.getElementById('loadStatus');
  status.className = 'loading';
  status.textContent = '‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ stations.js —Å GitHub‚Ä¶';
  try {
    // cache-bust —á—Ç–æ–±—ã –Ω–µ —á–∏—Ç–∞—Ç—å —Å—Ç–∞—Ä—ã–π –∫—ç—à –±—Ä–∞—É–∑–µ—Ä–∞
    const resp = await fetch(GH_RAW_URL + '?t=' + Date.now(), { cache: 'no-store' });
    if (!resp.ok) throw new Error('HTTP ' + resp.status);
    const text = await resp.text();
    parseStationsText(text);
    status.className = 'ok';
    status.textContent = '‚úÖ stations.js –∑–∞–≥—Ä—É–∂–µ–Ω —Å GitHub';
    document.getElementById('ghUploadBtn').disabled = false;
    render();
  } catch (e) {
    status.className = 'err';
    status.textContent = '‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å GitHub: ' + e.message + ' ‚Äî –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ';
    loadDefaults();
    document.getElementById('ghUploadBtn').disabled = false;
    render();
  }
}

// ==========  –ü–ê–†–°–ï–† –¢–ï–ö–°–¢–ê stations.js  ==========
function parseStationsText(text) {
  const defM  = text.match(/const\s+defaultCoords\s*=\s*({[\s\S]*?});/);
  const stM   = text.match(/this\.stations\s*=\s*({[\s\S]*?});/);
  const tmM   = text.match(/this\.travelTimes\s*=\s*({[\s\S]*?});/);
  const ordM  = text.match(/this\.participantOrders\s*=\s*({[\s\S]*?});/);
  const trfM  = text.match(/this\.treffpunkt\s*=\s*({[\s\S]*?});/);
  const trtM  = text.match(/this\.trefftravelTimes\s*=\s*({[\s\S]*?});/);

  if (!defM && !stM) throw new Error('–ù–µ –Ω–∞–π–¥–µ–Ω—ã –±–ª–æ–∫–∏ defaultCoords / stations');

  if (defM) data.defaultCoords = Function('"use strict";return (' + defM[1] + ')')();
  if (stM)  data.stations      = Function('"use strict";return (' + stM[1]  + ')')();
  if (tmM)  travelTimes        = Function('"use strict";return (' + tmM[1]  + ')')();
  if (ordM) participantOrders  = Function('"use strict";return (' + ordM[1] + ')')();
  if (trfM) treffpunkt         = Function('"use strict";return (' + trfM[1] + ')')();
  if (trtM) trefftravelTimes   = Function('"use strict";return (' + trtM[1] + ')')();
}

// ==========  –í–°–¢–†–û–ï–ù–ù–´–ï –î–ê–ù–ù–´–ï (–∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç)  ==========
function loadDefaults() {
  data = {
    defaultCoords: {
      'Sergii':    { lat: 51.530133, lng: 6.850858 },
      'Anatolii':  { lat: 51.522694, lng: 6.858944 },
      'Andrii':    { lat: 51.534558, lng: 6.861061 },
      'Sergio':    { lat: 51.520000, lng: 6.887619 },
      'Dima':      { lat: 51.551753, lng: 7.102285 },
      'Ren√©':      { lat: 51.476281, lng: 6.861856 },
      'Marvin':    { lat: 51.556472, lng: 6.731424 },
      'Vasyl':     { lat: 51.515355, lng: 6.893655 }
    },
    stations: {
      'Gelsenkirchen-Bismarck': { lat: 51.538627, lng: 7.108037 },
      'Hagen':                  { lat: 51.373517, lng: 7.461144 },
      'Essen West':             { lat: 51.4539273, lng: 6.9794622 }
    }
  };
  travelTimes = {
    'Sergii-Anatolii': 5, 'Sergii-Andrii': 5, 'Sergii-Sergio': 10, 'Sergii-Dima': 30,
    'Andrii-Anatolii': 5, 'Andrii-Sergio': 10, 'Andrii-Dima': 25,
    'Anatolii-Sergio': 10, 'Anatolii-Dima': 30, 'Sergio-Dima': 25,
    'Marvin-Sergii': 20, 'Marvin-Anatolii': 17, 'Marvin-Andrii': 20, 'Marvin-Sergio': 25, 'Marvin-Dima': 30,
    'Ren√©-Sergii': 15, 'Ren√©-Andrii': 15, 'Ren√©-Anatolii': 10, 'Ren√©-Sergio': 15, 'Ren√©-Dima': 25,
    'Vasyl-Sergii': 10, 'Vasyl-Andrii': 10, 'Vasyl-Anatolii': 10, 'Vasyl-Sergio': 5, 'Vasyl-Dima': 20
  };
  participantOrders = {
    'Sergii':   ['Anatolii', 'Andrii', 'Sergio', 'Dima'],
    'Anatolii': ['Sergii', 'Andrii', 'Sergio', 'Dima'],
    'Andrii':   ['Sergii', 'Anatolii', 'Sergio', 'Dima'],
    'Sergio':   ['Anatolii', 'Sergii', 'Andrii', 'Dima'],
    'Dima':     ['Anatolii', 'Sergii', 'Andrii', 'Sergio']
  };
  treffpunkt = {
    'OLGA-Park':               { lat: 51.5004335, lng: 6.8686337 },
    'Gelsenkirchen-Treffpunkt': { lat: 51.530304,  lng: 7.110901  }
  };
  trefftravelTimes = {
    'OLGA-Park-Sergii': 10, 'OLGA-Park-Andrii': 10, 'OLGA-Park-Anatolii': 10,
    'OLGA-Park-Sergio': 10, 'OLGA-Park-Dima': 20,   'OLGA-Park-Marvin': 20,
    'OLGA-Park-Ren√©': 5,    'OLGA-Park-Vasyl': 10,
    'Gelsenkirchen-Treffpunkt-Sergii': 30, 'Gelsenkirchen-Treffpunkt-Andrii': 30,
    'Gelsenkirchen-Treffpunkt-Anatolii': 30, 'Gelsenkirchen-Treffpunkt-Sergio': 25,
    'Gelsenkirchen-Treffpunkt-Dima': 10,  'Gelsenkirchen-Treffpunkt-Marvin': 20,
    'Gelsenkirchen-Treffpunkt-Ren√©': 35, 'Gelsenkirchen-Treffpunkt-Vasyl': 25
  };
}

// ==========  –£–¢–ò–õ–ò–¢–´  ==========
function addTravelLinks(newName) {
  Object.keys(data.defaultCoords).forEach(oldName => {
    if (oldName === newName) return;
    const key = `${newName}-${oldName}`;
    if (travelTimes[key] === undefined) travelTimes[key] = DEFAULT_TRAVEL_TIME;
  });
}
function removeTravelLinks(delName) {
  Object.keys(travelTimes).forEach(key => {
    if (key.startsWith(delName + '-') || key.endsWith('-' + delName)) delete travelTimes[key];
  });
}
function showMsg(text, ms = 500) {
  const msgContent = document.getElementById('msgContent');
  const msgModal   = document.getElementById('msgModal');
  msgContent.textContent = text;
  msgModal.style.display = 'flex';
  setTimeout(() => msgModal.style.display = 'none', ms);
}

// ==========  –†–ï–ù–î–ï–†  ==========
const groupSel = document.getElementById('groupSel');
groupSel.addEventListener('change', render);
function currentGroup() { return groupSel.value; }

function render() {
  const grp = currentGroup();
  const box = document.getElementById('cards');
  box.innerHTML = '';

  // -----  participantOrders  -----
  if (grp === 'participantOrders') {
    const drivers = Object.keys(data.defaultCoords).sort();
    const driverSel = document.createElement('select');
    driverSel.id = 'driverSel';
    drivers.forEach(d => {
      const opt = document.createElement('option');
      opt.value = opt.textContent = d;
      if (d === (participantOrders._lastDriver || drivers[0])) opt.selected = true;
      driverSel.appendChild(opt);
    });
    box.appendChild(driverSel);

    const riderSel = document.createElement('select');
    riderSel.id = 'riderSel';
    riderSel.style.marginLeft = '8px';
    function refillRiders() {
      riderSel.innerHTML = '';
      const already = participantOrders[driverSel.value] || [];
      drivers
        .filter(n => n !== driverSel.value && !already.includes(n))
        .forEach(n => {
          const opt = document.createElement('option');
          opt.value = opt.textContent = n;
          riderSel.appendChild(opt);
        });
    }
    refillRiders();

    const addBtn = document.createElement('button');
    addBtn.id = 'addRiderBtn';
    addBtn.textContent = '‚ûï';
    addBtn.onclick = () => {
      const driver = driverSel.value, rider = riderSel.value;
      if (!rider) return;
      if (!participantOrders[driver]) participantOrders[driver] = [];
      participantOrders[driver].push(rider);
      participantOrders._lastDriver = driver;
      render(); showMsg('–î–æ–±–∞–≤–ª–µ–Ω–æ');
    };
    box.appendChild(riderSel);
    box.appendChild(addBtn);

    const listBox = document.createElement('div');
    listBox.id = 'orderList';
    listBox.style.marginTop = '10px';
    box.appendChild(listBox);

    function rebuildList() {
      const driver = driverSel.value;
      participantOrders._lastDriver = driver;
      listBox.innerHTML = '';
      const order = participantOrders[driver] || [];
      order.forEach((name, idx) => {
        const div = document.createElement('div');
        div.className = 'card'; div.draggable = true; div.dataset.index = idx;
        div.innerHTML = `<span style="margin-right:auto;">${idx + 1}. ${name}</span>
                         <button class="delX" style="position:static;" data-name="${name}">‚úñ</button>`;
        listBox.appendChild(div);
      });
      listBox.querySelectorAll('.delX').forEach(btn => {
        btn.onclick = e => {
          e.stopPropagation();
          const arr = participantOrders[driverSel.value];
          const i = arr.indexOf(btn.dataset.name);
          if (i > -1) arr.splice(i, 1);
          rebuildList(); showMsg('–£–¥–∞–ª–µ–Ω–æ');
        };
      });
      if (listBox._sortable) listBox._sortable.destroy();
      listBox._sortable = new Sortable(listBox, {
        animation: 150,
        onEnd: () => {
          const newOrder = Array.from(listBox.children)
            .map(div => div.querySelector('span').textContent.split('. ')[1]);
          participantOrders[driverSel.value] = newOrder;
          rebuildList(); showMsg('–ü–æ—Ä—è–¥–æ–∫ –∏–∑–º–µ–Ω—ë–Ω');
        }
      });
    }
    driverSel.onchange = () => { refillRiders(); rebuildList(); };
    rebuildList();

    const clean = {};
    Object.keys(participantOrders)
      .filter(k => !k.startsWith('_'))
      .forEach(k => clean[k] = participantOrders[k]);
    document.getElementById('rawJson').value =
      'let participantOrders = ' + JSON.stringify(clean, null, 2) + ';';
    return;
  }

  // -----  treffpunkt  -----
  if (grp === 'treffpunkt') {
    for (const [name, coord] of Object.entries(treffpunkt)) {
      const card = document.createElement('div'); card.className = 'card';
      const x = document.createElement('span'); x.className = 'delX'; x.textContent = '‚úï';
      x.onclick = () => {
        Object.keys(trefftravelTimes).forEach(key => {
          if (key.startsWith(name + '-')) delete trefftravelTimes[key];
        });
        delete treffpunkt[name];
        render(); showMsg('–£–¥–∞–ª–µ–Ω–æ');
      };
      card.appendChild(x);
      const title = document.createElement('div'); title.className = 'card-title'; title.textContent = name;
      title.onclick = () => makeTreffTitleEditable(title, name);
      const coordDiv = document.createElement('div'); coordDiv.className = 'card-coord';
      const inp = document.createElement('input'); inp.type = 'text'; inp.value = `${coord.lat},${coord.lng}`;
      inp.addEventListener('change', async () => {
        const coords = await parseAnyCoords(inp.value.trim());
        if (coords) { inp.value = `${coords.lat},${coords.lng}`; treffpunkt[name] = coords; showMsg('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ'); }
        else { showMsg('–û—à–∏–±–∫–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç'); inp.value = `${coord.lat},${coord.lng}`; }
      });
      coordDiv.appendChild(inp); card.appendChild(title); card.appendChild(coordDiv); box.appendChild(card);
    }
    document.getElementById('rawJson').value = JSON.stringify(treffpunkt, null, 2);
    return;
  }

  // -----  trefftravelTimes  -----
  if (grp === 'trefftravelTimes') {
    for (const key of Object.keys(trefftravelTimes)) {
      const card = document.createElement('div'); card.className = 'card';
      const x = document.createElement('span'); x.className = 'delX'; x.textContent = '‚úï';
      x.onclick = () => { delete trefftravelTimes[key]; render(); showMsg('–£–¥–∞–ª–µ–Ω–æ'); };
      card.appendChild(x);
      const title = document.createElement('div'); title.className = 'card-title'; title.textContent = key; title.style.cursor = 'default';
      const timeInp = document.createElement('input'); timeInp.type = 'number'; timeInp.min = '1'; timeInp.max = '999';
      timeInp.value = trefftravelTimes[key]; timeInp.style.width = '60px';
      timeInp.addEventListener('change', () => {
        const v = parseInt(timeInp.value);
        if (v > 0) { trefftravelTimes[key] = v; showMsg('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ'); }
      });
      card.appendChild(title); card.appendChild(timeInp); box.appendChild(card);
    }
    document.getElementById('rawJson').value = JSON.stringify(trefftravelTimes, null, 2);
    return;
  }

  // -----  travelTimes  -----
  if (grp === 'travelTimes') {
    for (const key of Object.keys(travelTimes)) {
      const card = document.createElement('div'); card.className = 'card';
      const x = document.createElement('span'); x.className = 'delX'; x.textContent = '‚úï';
      x.onclick = () => { delete travelTimes[key]; render(); showMsg('–£–¥–∞–ª–µ–Ω–æ'); };
      card.appendChild(x);
      const title = document.createElement('div'); title.className = 'card-title'; title.textContent = key; title.style.cursor = 'default';
      const timeInp = document.createElement('input'); timeInp.type = 'number'; timeInp.min = '1'; timeInp.max = '999';
      timeInp.value = travelTimes[key]; timeInp.style.width = '60px';
      timeInp.addEventListener('change', () => {
        const v = parseInt(timeInp.value);
        if (v > 0) { travelTimes[key] = v; showMsg('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ'); }
      });
      card.appendChild(title); card.appendChild(timeInp); box.appendChild(card);
    }
    document.getElementById('rawJson').value = JSON.stringify(travelTimes, null, 2);
    return;
  }

  // -----  defaultCoords / stations  -----
  for (const [name, coord] of Object.entries(data[grp])) {
    const card = document.createElement('div'); card.className = 'card';
    const x = document.createElement('span'); x.className = 'delX'; x.textContent = '‚úï';
    x.onclick = () => {
      if (grp === 'defaultCoords') removeTravelLinks(name);
      delete data[grp][name];
      Object.keys(participantOrders).forEach(start => {
        if (!start.startsWith('_'))
          participantOrders[start] = participantOrders[start].filter(n => n !== name);
      });
      render(); showMsg('–£–¥–∞–ª–µ–Ω–æ');
    };
    card.appendChild(x);
    const title = document.createElement('div'); title.className = 'card-title'; title.textContent = name;
    title.onclick = () => makeTitleEditable(title, name, grp);
    const coordDiv = document.createElement('div'); coordDiv.className = 'card-coord';
    const inp = document.createElement('input'); inp.type = 'text'; inp.value = `${coord.lat},${coord.lng}`;
    inp.addEventListener('change', async () => {
      const coords = await parseAnyCoords(inp.value.trim());
      if (coords) {
        inp.value = `${coords.lat},${coords.lng}`; data[grp][name] = coords; render(); showMsg('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
      } else { showMsg('–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω—ã'); inp.value = `${coord.lat},${coord.lng}`; }
    });
    coordDiv.appendChild(inp); card.appendChild(title); card.appendChild(coordDiv); box.appendChild(card);
  }
  if (grp === 'stations') document.getElementById('rawJson').value = JSON.stringify(data.stations, null, 2);
  else                    document.getElementById('rawJson').value = JSON.stringify(data.defaultCoords, null, 2);
}

// ==========  –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï –ù–ê–ó–í–ê–ù–ò–ô  ==========
function makeTitleEditable(titleDiv, oldName, grp) {
  const input = document.createElement('input'); input.value = oldName;
  input.addEventListener('blur', () => finishTitleEdit(input, oldName, grp));
  input.addEventListener('keydown', e => { if (e.key === 'Enter') input.blur(); });
  titleDiv.innerHTML = ''; titleDiv.appendChild(input); input.focus(); input.select();
}
function finishTitleEdit(input, oldName, grp) {
  const newName = input.value.trim(); const titleDiv = input.parentElement;
  if (!newName || newName === oldName) { titleDiv.textContent = oldName; return; }
  if (data[grp][newName]) { showMsg('–¢–∞–∫–∞—è —Ç–æ—á–∫–∞ —É–∂–µ –µ—Å—Ç—å'); titleDiv.textContent = oldName; return; }
  data[grp][newName] = data[grp][oldName]; delete data[grp][oldName];
  if (grp === 'defaultCoords') {
    removeTravelLinks(oldName); addTravelLinks(newName);
    Object.keys(participantOrders).forEach(start => {
      if (!start.startsWith('_'))
        participantOrders[start] = participantOrders[start].map(n => n === oldName ? newName : n);
    });
  }
  render(); showMsg('–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–æ');
}

// ==========  –ü–ï–†–ï–ò–ú–ï–ù–û–í–ê–ù–ò–ï TREFFPUNKT  ==========
function makeTreffTitleEditable(titleDiv, oldName) {
  const input = document.createElement('input'); input.value = oldName;
  input.addEventListener('blur', () => {
    const newName = input.value.trim();
    if (!newName || newName === oldName) { titleDiv.textContent = oldName; return; }
    if (treffpunkt[newName]) { showMsg('–¢–∞–∫–æ–π –ø—É–Ω–∫—Ç —É–∂–µ –µ—Å—Ç—å'); titleDiv.textContent = oldName; return; }
    treffpunkt[newName] = treffpunkt[oldName]; delete treffpunkt[oldName];
    const prefix = oldName + '-';
    Object.keys(trefftravelTimes).filter(k => k.startsWith(prefix)).forEach(k => {
      const newKey = newName + '-' + k.slice(prefix.length);
      trefftravelTimes[newKey] = trefftravelTimes[k];
      delete trefftravelTimes[k];
    });
    render(); showMsg('–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–æ');
  });
  input.addEventListener('keydown', e => { if (e.key === 'Enter') input.blur(); });
  titleDiv.innerHTML = ''; titleDiv.appendChild(input); input.focus(); input.select();
}

// ==========  –ö–ù–û–ü–ö–ò –ù–ò–ñ–ù–ï–ô –ü–ê–ù–ï–õ–ò  ==========
document.getElementById('addBtn').onclick = () => {
  const grp = currentGroup();
  const modalSel = document.getElementById('modalGroupSel');
  if ([...modalSel.options].some(o => o.value === grp)) modalSel.value = grp;
  updateAddModalPlaceholder();
  document.getElementById('addModal').style.display = 'flex';
  document.getElementById('newName').focus();
};
document.getElementById('modalGroupSel').addEventListener('change', updateAddModalPlaceholder);
function updateAddModalPlaceholder() {
  const grp = document.getElementById('modalGroupSel').value;
  const coordInp = document.getElementById('newCoord');
  const nameInp  = document.getElementById('newName');
  if (grp === 'travelTimes')      { nameInp.placeholder = '–ö–ª—é—á: –ò–º—è1-–ò–º—è2'; coordInp.placeholder = '–í—Ä–µ–º—è (–º–∏–Ω—É—Ç—ã)'; }
  else if (grp === 'trefftravelTimes') { nameInp.placeholder = '–ö–ª—é—á: –ü—É–Ω–∫—Ç-–ò–º—è'; coordInp.placeholder = '–í—Ä–µ–º—è (–º–∏–Ω—É—Ç—ã)'; }
  else                            { nameInp.placeholder = '–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ—á–∫–∏'; coordInp.placeholder = '–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã (lat,lng)'; }
}
document.getElementById('addCancel').onclick = () => document.getElementById('addModal').style.display = 'none';
document.getElementById('addConfirm').onclick = () => {
  const grp  = document.getElementById('modalGroupSel').value;
  const name = document.getElementById('newName').value.trim();
  const val  = document.getElementById('newCoord').value.trim();
  if (!name) { showMsg('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ / –∫–ª—é—á'); return; }

  if (grp === 'travelTimes') {
    if (travelTimes[name] !== undefined) { showMsg('–¢–∞–∫–æ–π –∫–ª—é—á —É–∂–µ –µ—Å—Ç—å'); return; }
    travelTimes[name] = parseInt(val) || 5;
  } else if (grp === 'trefftravelTimes') {
    if (trefftravelTimes[name] !== undefined) { showMsg('–¢–∞–∫–æ–π –∫–ª—é—á —É–∂–µ –µ—Å—Ç—å'); return; }
    trefftravelTimes[name] = parseInt(val) || 5;
  } else if (grp === 'treffpunkt') {
    if (treffpunkt[name]) { showMsg('–ü—É–Ω–∫—Ç —É–∂–µ –µ—Å—Ç—å'); return; }
    const m = val.match(/^([-+]?\d*\.?\d+),([-+]?\d*\.?\d+)$/);
    treffpunkt[name] = { lat: m ? parseFloat(m[1]) : 0, lng: m ? parseFloat(m[2]) : 0 };
  } else {
    if (data[grp][name]) { showMsg('–¢–æ—á–∫–∞ —É–∂–µ –µ—Å—Ç—å'); return; }
    const m = val.match(/^([-+]?\d*\.?\d+),([-+]?\d*\.?\d+)$/);
    data[grp][name] = { lat: m ? parseFloat(m[1]) : 0, lng: m ? parseFloat(m[2]) : 0 };
    if (grp === 'defaultCoords') addTravelLinks(name);
  }
  render();
  document.getElementById('addModal').style.display = 'none';
  document.getElementById('newName').value = '';
  document.getElementById('newCoord').value = '';
  showMsg('–î–æ–±–∞–≤–ª–µ–Ω–æ');
};

document.getElementById('copyBtn').onclick = () => {
  const ta = document.getElementById('rawJson'); ta.select();
  document.execCommand('copy'); window.getSelection().removeAllRanges();
  showMsg('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ');
};

// –ó–∞–≥—Ä—É–∑–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª
document.getElementById('loadBtn').onclick = () => document.getElementById('fileInput').click();
document.getElementById('fileInput').addEventListener('change', e => {
  const file = e.target.files[0]; if (!file) return;
  const reader = new FileReader();
  reader.onload = evt => {
    try {
      parseStationsText(evt.target.result);
      document.getElementById('loadStatus').className = 'ok';
      document.getElementById('loadStatus').textContent = '‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ñ–∞–π–ª–∞: ' + file.name;
      render(); showMsg('–ó–∞–≥—Ä—É–∂–µ–Ω–æ');
    } catch { showMsg('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞'); }
  };
  reader.readAsText(file, 'utf-8');
  e.target.value = '';  // —Å–±—Ä–æ—Å —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–æ—Ç –∂–µ —Ñ–∞–π–ª –ø–æ–≤—Ç–æ—Ä–Ω–æ
});

// –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ
document.getElementById('saveBtn').onclick = exportAsJS;
document.getElementById('applyRaw').onclick = () => {
  try {
    const grp = currentGroup();
    if      (grp === 'travelTimes')      travelTimes      = JSON.parse(document.getElementById('rawJson').value);
    else if (grp === 'trefftravelTimes') trefftravelTimes = JSON.parse(document.getElementById('rawJson').value);
    else if (grp === 'treffpunkt')       treffpunkt       = JSON.parse(document.getElementById('rawJson').value);
    else data = JSON.parse(document.getElementById('rawJson').value);
    render(); showMsg('–ü—Ä–∏–º–µ–Ω–µ–Ω–æ');
  } catch { showMsg('–û—à–∏–±–∫–∞ JSON'); }
};

// ==========  –≠–ö–°–ü–û–†–¢  ==========
function buildExportText() {
  const defLines = []; for (const [n, c] of Object.entries(data.defaultCoords)) defLines.push(`  '${n}': {lat: ${c.lat}, lng: ${c.lng}}`);
  const stLines  = []; for (const [n, c] of Object.entries(data.stations))      stLines.push(`  '${n}': {lat: ${c.lat}, lng: ${c.lng}}`);
  const tmLines  = []; for (const [p, t] of Object.entries(travelTimes))        tmLines.push(`  '${p}': ${t}`);
  const trfLines = []; for (const [n, c] of Object.entries(treffpunkt))         trfLines.push(`  '${n}': {lat: ${c.lat}, lng: ${c.lng}}`);
  const trtLines = []; for (const [p, t] of Object.entries(trefftravelTimes))   trtLines.push(`  '${p}': ${t}`);
  const ordLines = [];
  Object.keys(participantOrders).filter(k => !k.startsWith('_'))
        .forEach(start => ordLines.push(`  '${start}': [${participantOrders[start].map(n=>`'${n}'`).join(', ')}]`));
  return `// —Ä–µ–µ—Å—Ç—Ä –∏–º–µ–Ω
const defaultCoords = {
${defLines.join(',\n')}
};

// —Ä–µ–µ—Å—Ç—Ä —Å—Ç–∞–Ω—Ü–∏–π
this.stations = {
${stLines.join(',\n')}
};

// –í—Ä–µ–º—è –≤ –ø—É—Ç–∏ –º–µ–∂–¥—É —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏
this.travelTimes = {
${tmLines.join(',\n')}
};

// –ü—É–Ω–∫—Ç—ã –≤—Å—Ç—Ä–µ—á–∏ (Treffpunkt)
this.treffpunkt = {
${trfLines.join(',\n')}
};

// –í—Ä–µ–º—è –≤ –ø—É—Ç–∏ –æ—Ç –ø—É–Ω–∫—Ç–∞ –≤—Å—Ç—Ä–µ—á–∏ –¥–æ –∫–∞–∂–¥–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞
this.trefftravelTimes = {
${trtLines.join(',\n')}
};

// –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ —Å–ø–∏—Å–∫–∏ –æ—Å—Ç–∞–Ω–æ–≤–æ–∫
this.participantOrders = {
${ordLines.join(',\n')}
};`;
}

function exportAsJS() {
  const text = buildExportText();
  const blob = new Blob([text], {type:'application/javascript;charset=utf-8'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'stations.js'; a.click();
  URL.revokeObjectURL(a.href);
  showMsg('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
}
function buildStationsText() { return buildExportText(); }

// ==========  –ü–ê–†–°–ï–† –ö–û–û–†–î–ò–ù–ê–¢  ==========
async function parseAnyCoords(s) {
  if (!s) return null; s = s.trim();
  if (/^-?\d{1,2},\d+\s*,\s*-?\d{1,3},\d+$/.test(s)) {
    const p = s.split(',').map(t => t.trim());
    const lat = parseFloat(p[0] + '.' + p[1]), lng = parseFloat(p[2] + '.' + p[3]);
    if (Math.abs(lat) <= 90 && Math.abs(lng) <= 180) return { lat, lng };
  }
  if (/^-?\d{1,2}(?:\.\d+)?\s*,\s*-?\d{1,3}(?:\.\d+)?$/.test(s)) {
    const [l, ln] = s.split(',').map(Number);
    if (Math.abs(l) <= 90 && Math.abs(ln) <= 180) return { lat: l, lng: ln };
  }
  const m1 = s.match(/@(-?\d+\.\d+),(-?\d+\.\d+)/) || s.match(/ll=(-?\d+\.\d+),(-?\d+\.\d+)/) || s.match(/place\/[^\/]+\/(-?\d+\.\d+),(-?\d+\.\d+)/);
  if (m1) { const lat = +m1[1], lng = +m1[2]; if (Math.abs(lat) <= 90 && Math.abs(lng) <= 180) return { lat, lng }; }
  const dms = [...s.matchAll(/(\d{1,3})¬∞(\d{1,2})'(\d{1,2}(?:\.\d+)?)"?\s*([NSEW])/gi)];
  if (dms.length === 2) {
    try {
      const toDec = ([, d, mi, sec, dir]) => { let dec = +d + mi / 60 + sec / 3600; if (/S|W/i.test(dir)) dec = -dec; return dec; };
      const lat = toDec(dms[0]), lng = toDec(dms[1]);
      if (Math.abs(lat) <= 90 && Math.abs(lng) <= 180) return { lat, lng };
    } catch {}
  }
  if (/^https?:\/\//i.test(s)) {
    try {
      const expanded = await expandShortUrl(s);
      const coords = await parseAnyCoords(expanded);
      if (coords) return coords;
    } catch {}
  }
  const coords = parseCoordsFromUrl(s);
  if (coords) return coords;
  alert('–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω—ã'); return null;
}
function parseCoordsFromUrl(url) {
  const m = url.match(/@(-?\d+\.\d+),(-?\d+\.\d+)/) || url.match(/ll=(-?\d+\.\d+),(-?\d+\.\d+)/);
  if (m) { const lat = +m[1], lng = +m[2]; if (Math.abs(lat) <= 90 && Math.abs(lng) <= 180) return { lat, lng }; }
  return null;
}
async function expandShortUrl(url) {
  const r = await fetch(url, { method: 'HEAD', mode: 'no-cors' });
  return r.url || url;
}

// ======  –ó–ê–ì–†–£–ó–ö–ê stations.js –ù–ê GITHUB  ======
document.getElementById('ghUploadBtn').onclick = () => {
  document.getElementById('ghTokenInp').value = localStorage.ghToken || '';
  document.getElementById('ghModal').style.display = 'flex';
  document.getElementById('ghTokenInp').focus();
};

document.getElementById('ghCancelBtn').onclick = () =>
  document.getElementById('ghModal').style.display = 'none';

document.getElementById('ghSendStationsBtn').onclick = async () => {
  const token = document.getElementById('ghTokenInp').value.trim();
  if (!token) { alert('–í–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω'); return; }
  await uploadToGitHub(token, GH_FILE, buildStationsText());
};

document.getElementById('ghSendAnyBtn').onclick = async () => {
  const token = document.getElementById('ghTokenInp').value.trim();
  if (!token) { alert('–í–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω'); return; }
  const fileInput = document.getElementById('ghAnyFile');
  const nameInput = document.getElementById('ghAnyName');
  if (!fileInput.files.length) { alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª'); return; }
  const file = fileInput.files[0];
  const path = nameInput.value.trim() || file.name;
  const content = await file.text();
  await uploadToGitHub(token, path, content);
};

async function uploadToGitHub(token, path, text) {
  localStorage.ghToken = token;

  const base64 = btoa(unescape(encodeURIComponent(text)));

  let sha;
  try {
    const head = await fetch(`https://api.github.com/repos/${GH_OWNER}/${GH_REPO}/contents/${path}`, {
      headers: { Authorization: `token ${token}` }
    });
    if (head.ok) sha = (await head.json()).sha;
  } catch (e) {}

  const body = JSON.stringify({ message: `web-update ${path}`, content: base64, sha });

  const resp = await fetch(`https://api.github.com/repos/${GH_OWNER}/${GH_REPO}/contents/${path}`, {
    method: 'PUT',
    headers: { Authorization: `token ${token}`, 'Content-Type': 'application/json' },
    body
  });

  document.getElementById('ghModal').style.display = 'none';

  if (resp.ok) {
    showMsg(`${path} uploaded ‚úî`, 1500);
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
    document.getElementById('loadStatus').className = 'ok';
    document.getElementById('loadStatus').textContent = `‚úÖ ${path} –∑–∞–≥—Ä—É–∂–µ–Ω –Ω–∞ GitHub`;
  } else {
    const err = await resp.json();
    alert('Upload error:\n' + err.message);
  }
}

// ==========  –°–¢–ê–†–¢ ‚Äî –∑–∞–≥—Ä—É–∂–∞–µ–º stations.js  ==========
loadFromGitHub();
</script>
<a id="downLink" style="display:none"></a>

</body>
</html>

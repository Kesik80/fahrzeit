<!-- 
+ 30.09.2025 13:00: при добавлении нового   участника поле «Координаты» теперь НЕ обязательно;
+ 30.09.2025 14:00: добавил René, OLGA-Park;
- выпадающий список точек станций

-->

<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    
    <!-- иконка для iOS -->
<link rel="apple-touch-icon" href="/icons/icon-192.png">

<!-- иконка для Android / PWA -->
<link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192.png">
<link rel="icon" type="image/png" sizes="512x512" href="/icons/icon-512.png">

<!-- манифест -->
<link rel="manifest" href="/icons/manifest.json">

<!-- цвет статус-бара (опционально) -->
<meta name="theme-color" content="#007bff" id="theme-meta">
<meta name="apple-mobile-web-app-status-bar-style" content="default">

    
    <title>Fahrzeit Rechner</title>
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&icon_names=swap_vert" />
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.6/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/latlon-geohash@2.0.0/latlon-geohash.min.js"></script>
    

    
    

    

    <style>
    
        :root {
            --primary-color: #007bff;
            --success-color: #28a745;
            --info-color: #6c757d;
            --danger-color: #dc3545;
            --background-color: #f0f0f0;
            --surface-color: white;
            --text-color: #333;
            --border-radius: 6px;
            --spacing-unit: 10px;
            --small-spacing: 6px;
            --button-size: 44px;
            --button-font-size: 0.9em;
        }

        body {
            font-family: sans-serif;
            padding: 10px;
            max-width: 500px;
            margin: auto;
            background: var(--bg) !important;
            color: var(--text) !important;
        }

        h2 {
            text-align: center
        }

        button {
            padding: var(--spacing-unit);
            margin-top: var(--spacing-unit);
            width: 100%;
            border: none;
            border-radius: var(--border-radius);
            color: white;
            cursor: pointer;
            font-size: var(--button-font-size);
            transition: background-color .2s ease, transform .1s ease;
            height: var(--button-size);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px
        }

        button:hover {
            opacity: .9;
            transform: translateY(-1px)
        }

        .calculate {
            background: var(--primary-color)
        }

        .copy {
            background: var(--success-color)
        }

        .add {
            background: var(--info-color)
        }

        .clear {
            background: var(--danger-color)
        }

        .route-back {
            background: #6f42c1
        }

        .greeting-container {
            background: var(--surface-color);
            border-radius: var(--border-radius);
            padding: var(--spacing-unit);
            margin-bottom: var(--spacing-unit);
            box-shadow: 0 1px 3px rgba(0, 0, 0, .1);
            display: flex;
            align-items: center;
            gap: var(--spacing-unit);
            flex-wrap: wrap
        }

        .greeting-container select {
            width: 35%;
            padding: var(--small-spacing);
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1em;
            box-sizing: border-box
        }

        .greeting-container .edit-greeting-btn,
        .greeting-container .start-point-coords {
            width: 24px;
            height: 24px;
            background: transparent;
            border: none;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            flex-shrink: 0;
            line-height: 1;
            padding: 0;
            color: var(--text) !important;
        }

        .participant {
            background: var(--surface-color);
            border-radius: var(--border-radius);
            padding: var(--spacing-unit);
            margin-bottom: var(--spacing-unit);
            display: flex;
            align-items: center;
            gap: var(--spacing-unit);
            flex-wrap: wrap;
            box-shadow: 0 1px 3px rgba(0, 0, 0, .1)
        }

        .participant select,
        .participant input[type=text] {
            flex: 1;
            min-width: 35%;
            max-width: 35%;
            padding: var(--small-spacing);
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1em;
            box-sizing: border-box
        }

        .participant input[type=number] {
            width: 50px;
            padding: var(--small-spacing);
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1em;
            text-align: center
        }

        .participant .right-section {
            margin-left: auto;
            display: flex;
            gap: var(--small-spacing);
            align-items: center;
            justify-content: flex-end;
            min-height: 32px;
        }

        .participant .remove-btn {
            width: 20px;
            height: 20px;
            background: var(--danger-color);
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            flex-shrink: 0;
            line-height: 1;
            padding: 0;
            transform: translate(5px, -15px);

        }


        .time-remove {
            width: 24px;
            height: 24px;
            background: transparent;
            color: var(--danger-color);
            border: none;
            border-radius: 4px;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            flex-shrink: 0;
            line-height: 1;
            transform: translateY(-5px);
            margin-top: -5px;
            margin-right: -7px;
        }
/* красные крестики ВСЕГДА */
.time-remove,
.remove-btn {
  background: transparent !important;   /* фон прозрачный */
  color: #dc3545 !important;            /* красный крестик */
  border: none !important;
  border-radius: 4px;
  cursor: pointer;
}

        .arrival-time {
            font-weight: bold;
            cursor: pointer;
            font-size: 1em;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: var(--small-spacing);
            border-radius: 4px;
            line-height: 1;
            background: var(--surface);
  color: var(--text);
  border: 2px solid var(--border);
  padding: var(--small-spacing);
        }

        .time-icon,
        .coords-icon,
        .start-point-coords {
            font-size: 24px;
            width: 24px;
            height: 24px;
            border: none;
            background: transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            line-height: 1;
            padding: 0;
            transform: translateY(-5px)
        }

        .coords-icon svg {
            width: 100%;
            height: 100%
        }

        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
            font-size: 24px;
            color: var(--info-color);
            transform: translate(-15px, 0);
            cursor: grab
        }

        input,
        select {
            font-size: 1em
        }

        pre {
            background: var(--surface-color);
            padding: var(--spacing-unit);
            border-radius: var(--border-radius);
            white-space: pre-wrap;
            font-size: 1.1em;
            margin-top: 15px;
            min-height: 50px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, .1)
        }

        .toast {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--danger-color);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1.2em;
            display: none;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0, 0, 0, .2);
            text-align: center
        }

        .sortable-ghost {
            opacity: .2;
            background: #c8ebfb
        }

        .button-container {
            display: flex;
            flex-direction: row;
            gap: 6px;
            margin-top: var(--spacing-unit);
            flex-wrap: nowrap
        }

        .button-container button {
            flex: 1;
            margin-top: 0;
            padding: var(--small-spacing) 8px;
            font-size: .8em;
            min-width: 60px
        }

        .button-container .add {
            grid-column: span 2
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, .5);
            z-index: 1000;
            justify-content: center;
            align-items: center
        }

        .modal-content {
            background: var(--surface-color);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: 0 2px 8px rgba(0, 0, 0, .2);
            max-width: 300px;
            width: 100%;
            text-align: center;
            border: 1px solid var(--border);
            transition: transform .2s ease
        }

        .modal-content.add-new-name {
            background: linear-gradient(135deg, #f0f8ff 0%, #e6f0fa 100%);
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, .3);
            transform: scale(1.02)
        }

        .modal-content.add-new-name h3 {
            font-size: 1.4em;
            color: #1a3c6d;
            margin-bottom: 15px
        }

        .modal-content.add-new-name label {
            font-size: 1.1em;
            color: #1a3c6d;
            font-weight: 500
        }

        .modal-content input[type=text] {
            width: 100%;
            padding: 8px;
            margin: 8px 0;
            border: 1px solid #b0c4de;
            border-radius: 4px;
            font-size: 1em;
            box-sizing: border-box
        }

        .modal-buttons {
            display: flex;
            flex-direction: row;
            gap: var(--spacing-unit);
            justify-content: center;
            margin-top: var(--spacing-unit)
        }

        .modal-content button {
            flex: 1;
            max-width: 120px;
            padding: 10px;
            margin: 0;
            border-radius: 4px;
            font-size: 1em;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color .2s ease, transform .1s ease
        }

        .modal-content button:hover {
            transform: translateY(-1px)
        }

        .modal-content .save-button {
            background: var(--success-color)
        }

        .modal-content .cancel-button {
            background: var(--info-color)
        }

        .modal-content .delete-greeting-btn {
            background: var(--danger-color)
        }

        .modal-content .map-button {
            display: block;
            margin-left: auto;
            margin-right: auto;
            margin-top: var(--spacing-unit);
            margin-bottom: var(--spacing-unit);
            background: var(--primary-color);
        }

        #result {
            font-family: Arial, sans-serif;
            font-size: 16px;
            line-height: 1.5;
            margin: 10px 0;
            white-space: pre-wrap
        }

        #result sup {
            font-size: .7em;
            vertical-align: super
        }

        .checkbox-container {
            display: flex;
            gap: var(--small-spacing);
            margin-top: var(--spacing-unit);
            justify-content: flex-end;
        }
        
/* /* ----------  СВЕТЛАЯ (уже есть) ---------- */
:root {
  --bg: #f0f0f0;
  --text: #333333;
  --surface: #ffffff;
  /*кнопки */
  --primary-color: #007bff;
  --success-color: #28a745;
  --info-color: #6c757d;
  --danger-color: #dc3545;
  --route-back-color: #6f42c1;
}

body.dark {
      --bg: #121212;
  --surface: #1e1e1e;
  --text: #e1e1e1;
  --border: #333333;
  /* кнопки */
  --primary-color: #007bff;
  --success-color: #28a745;
  --info-color: #6c757d;
  --danger-color: #dc3545;
  --route-back-color: #6f42c1;
      /* модальное окно*/
  --modal-bg: #121212;   /* тёмно-серый ночью */
  --modal-text: #fff;
  
  
}

body.dark .participant.machine {
  background: var(--surface);
  border-color: var(--border);
}



/* обязательно «покрасить» всё, что было белым/серым */
body {
  background: var(--bg) !important;
  color: var(--text) !important;
}

/* контейнеры, карточки, модалки, поля ввода */
.greeting-container,
.participant,
pre,
input,
select {
  background: var(--surface) !important;
  color: var(--text) !important;
  border-color: var(--text) !important;
}

/* кнопки сохраняют цвет, но текст перекрашиваем/* обязательно покрасить сами кнопки */
button.calculate { background: var(--primary-color) !important; }
button.copy       { background: var(--success-color) !important; }
button.add        { background: var(--info-color) !important; }
button.clear      { background: var(--danger-color) !important; }
button.route-back { background: var(--route-back-color) !important; }


/* переключатель остаётся на месте */
.theme-toggle {
  position: fixed;
  top: 10px;
  right: 10px;
  z-index: 999;
}
.theme-toggle input { display: none; }
.theme-toggle span {
  cursor: pointer;
  font-size: 24px;
  user-select: none;


/* жёстко тёмный фон и светлый текст */
body.dark pre#output {
  background: #1e1e1e !important;
  color: #e1e1e1 !important;
  border: 1px solid #333 !important;
  border-radius: 6px !important;
  padding: 10px !important;
  margin: 0 !important;
}

/* цветные кнопки модалки – всегда свои */
.modal-btn                       { color: #fff !important; border: none !important; }
.modal-btn.save-button           { background: var(--success-color) !important; }
.modal-btn.cancel-button         { background: var(--info-color)    !important; }
.modal-btn.map-button            { background: var(--primary-color) !important; }
.modal-btn.delete-greeting-btn   { background: var(--danger-color)  !important; }

/* фон модалки – переключается вместе с темой */
.modal-content                   { background: #aaaaaa !important; color: #000 !important; }
body.dark .modal-content        { background: #444444 !important; color: #fff !important
; 
    border: 1px solid #666 !important;
}
/* цвет карандаша – вместе с темой */
.pencil-icon {
  width: 18px;
  height: 18px;
  fill: var(--text) !important;   /* будет чёрным днём, белым ночью */
}


.god-mode{
  position:fixed;
  inset:0 auto auto 0;
  margin:4px;
  z-index:9999;
  background:none;
  padding:4px;
  cursor:pointer;
}



        
    </style>
</head>

<body>
    <main>
        <h2>Fahrzeit Rechner</h2>
        
<!-- переключатель темы (уже есть) -->
<label class="theme-toggle">
  <input type="checkbox" id="themeSwitch">
  <span>🌙</span>
</label>

<!-- ⛳ РЕЖИМ БОГА -->
<a id="godL" href="redaktor.html"
   style="position:fixed; inset:1px auto auto 3px; margin:4px; z-index:9999; background:none; padding:4px; cursor:pointer;color:var(--text);"
   title="Режим Бога">
<svg width="32" height="32" viewBox="0 0 374 383" xmlns="http://www.w3.org/2000/svg">
  <g transform="translate(0,383) scale(0.085,-0.085)" fill="currentColor" stroke="none">
    <path d="M144 3732 c-87 -5 -83 17 -84 -427 l-2 -390 28 -24 28 -23 27 30 28 31 1 338 c0 185 3 339 6 342 3 3 159 6 346 6 l340 0 19 24 c20 25 18 54 -5 79 -9 9 -91 13 -347 15 -184 1 -357 1 -385 -1z"/>
    <path d="M2920 3730 c-57 -4 -66 -8 -79 -32 -12 -20 -13 -31 -4 -51 15 -32 79 -42 194 -32 44 4 181 4 305 0 l224 -7 0 -337 c0 -185 3 -346 6 -358 8 -29 49 -38 80 -18 l24 15 0 394 c0 367 -1 394 -18 409 -16 15 -58 17 -343 19 -178 2 -353 1 -389 -2z"/>
    <path d="M1850 3459 c-63 -4 -149 -9 -192 -11 -42 -1 -74 -5 -72 -8 4 -3 -138 -38 -173 -42 -7 -1 -11 -4 -11 -7 1 -3 -2 -14 -6 -23 -12 -28 -2 -62 22 -74 17 -8 41 -7 105 7 142 31 248 40 387 36 141 -5 192 -10 250 -26 123 -33 165 -30 176 14 11 44 -17 72 -86 86 -33 6 -58 14 -56 18 2 3 -19 7 -46 8 -28 1 -58 5 -67 9 -9 4 -27 6 -41 5 -14 -1 -37 2 -50 6 -14 5 -77 6 -140 2z"/>
    <path d="M1725 3199 c-38 -4 -112 -17 -163 -29 -51 -12 -101 -23 -110 -25 -9 -2 -19 -4 -22 -5 -3 -1 -8 -2 -12 -1 -5 0 -8 -4 -8 -9 0 -5 -9 -10 -19 -10 -11 0 -23 -5 -26 -11 -4 -6 -13 -8 -20 -5 -8 3 -19 -2 -25 -9 -7 -8 -15 -14 -18 -13 -4 1 -17 -3 -29 -10 -13 -7 -23 -10 -23 -7 0 3 -6 1 -12 -5 -24 -20 -133 -83 -145 -83 -7 0 -11 -3 -8 -5 3 -3 -19 -21 -48 -40 -28 -20 -55 -40 -59 -46 -5 -7 -8 -7 -8 -1 0 15 -40 -54 -40 -70 0 -7 12 -23 26 -34 32 -25 49 -19 138 48 37 28 74 51 82 51 7 0 14 4 14 8 0 12 76 53 84 45 3 -3 6 0 6 7 0 7 3 11 6 7 4 -3 13 1 21 9 8 8 19 12 24 9 5 -4 9 -2 9 3 0 7 28 19 90 37 3 1 16 6 30 12 14 6 41 14 60 19 19 4 37 8 40 9 77 22 124 27 308 34 179 6 192 10 192 51 0 40 -13 60 -44 65 -47 9 -212 11 -291 4z"/>
    <path d="M2160 3152 c-14 -9 -26 -27 -28 -40 -4 -23 25 -78 35 -68 3 3 21 -1 39 -9 19 -8 34 -11 34 -8 0 3 6 1 13 -5 7 -6 28 -14 46 -17 18 -3 47 -13 65 -22 17 -10 33 -17 36 -18 15 -1 70 -28 70 -34 0 -4 15 -12 33 -19 18 -7 42 -20 53 -29 10 -10 31 -24 45 -31 15 -8 37 -24 50 -36 68 -61 105 -67 135 -21 13 19 13 28 3 47 -14 27 -56 68 -69 68 -5 0 -15 8 -22 19 -7 10 -17 18 -21 19 -5 0 -20 9 -33 21 -13 11 -26 21 -29 21 -3 -1 -26 11 -51 26 -50 29 -218 104 -234 104 -6 0 -10 4 -10 8 0 5 -6 9 -12 9 -16 1 -88 19 -108 27 -8 3 -26 -2 -40 -12z"/>
    <path d="M1839 2945 c-2 -1 -40 -4 -84 -6 -44 -1 -84 -6 -90 -10 -5 -4 -30 -9 -55 -12 -25 -3 -63 -12 -85 -20 -22 -9 -49 -17 -60 -19 -11 -2 -23 -7 -26 -11 -3 -4 -15 -9 -27 -10 -11 0 -18 -5 -16 -9 3 -4 0 -8 -6 -8 -13 0 -173 -79 -180 -89 -3 -4 -12 -10 -22 -14 -25 -9 -33 -63 -14 -92 20 -31 65 -33 91 -5 10 11 22 17 26 14 5 -3 9 -1 9 4 0 5 32 26 70 46 39 21 70 34 70 31 0 -3 10 0 23 7 12 6 27 13 32 15 6 1 29 9 52 17 23 9 57 18 75 21 18 3 51 10 73 15 44 10 318 8 378 -3 21 -4 54 -14 73 -22 19 -8 34 -12 34 -10 0 3 25 -6 56 -20 31 -14 63 -25 70 -25 8 0 14 -5 14 -11 0 -5 4 -8 9 -4 5 3 15 0 23 -7 7 -7 35 -24 61 -38 26 -13 47 -28 47 -32 0 -5 6 -8 13 -8 14 0 53 -31 125 -97 49 -46 79 -53 105 -25 33 37 22 67 -55 142 -40 38 -78 70 -85 70 -7 0 -13 5 -13 10 0 6 -7 10 -15 10 -8 0 -15 4 -15 10 0 5 -11 12 -25 16 -14 3 -25 10 -25 14 0 4 -8 10 -17 14 -10 3 -33 15 -50 26 -18 11 -33 18 -33 15 0 -2 -25 7 -55 21 -31 13 -62 24 -70 24 -8 0 -15 5 -15 11 0 5 -4 8 -10 4 -5 -3 -17 -1 -27 4 -16 9 -70 20 -168 36 -45 7 -182 15 -186 10z"/>
    <path d="M1758 2685 c-2 -2 -21 -6 -43 -9 -88 -13 -110 -18 -116 -28 -3 -5 -9 -9 -13 -9 -27 5 -191 -67 -237 -103 -14 -12 -40 -32 -59 -46 -18 -14 -39 -31 -46 -37 -7 -7 -14 -13 -17 -13 -7 0 -131 -125 -129 -131 0 -3 -14 -23 -32 -43 -19 -20 -32 -36 -29 -36 2 0 -8 -17 -22 -37 -14 -21 -25 -47 -25 -59 0 -39 53 -68 87 -46 7 4 30 35 51 67 54 83 130 165 216 229 330 248 736 239 1071 -25 65 -51 153 -151 191 -214 46 -79 104 -200 104 -217 0 -9 4 -27 9 -40 15 -39 32 -102 35 -130 6 -60 65 -88 101 -48 20 22 17 62 -15 183 -10 39 -17 75 -14 79 3 4 1 8 -4 8 -9 0 -54 107 -51 124 0 5 -4 12 -9 15 -14 9 -65 94 -65 108 0 7 -2 11 -5 8 -7 -7 -61 67 -62 84 0 8 -2 12 -5 9 -6 -6 -135 122 -135 134 0 5 -4 6 -10 3 -5 -3 -10 -1 -10 4 0 6 -6 11 -14 11 -8 0 -16 3 -18 8 -6 14 -76 61 -82 55 -3 -4 -6 -2 -6 4 0 10 -39 31 -130 71 -19 9 -39 17 -45 18 -5 1 -37 10 -70 19 -33 9 -71 18 -85 21 -28 5 -258 13 -262 9z"/>
    <path d="M989 2559 c-43 -44 -79 -84 -79 -89 0 -6 -9 -15 -20 -22 -11 -7 -20 -17 -20 -21 0 -5 -18 -34 -40 -66 -22 -31 -40 -62 -40 -69 0 -7 -5 -12 -10 -12 -6 0 -10 -3 -9 -7 2 -16 -14 -53 -23 -53 -5 0 -6 -4 -3 -10 3 -5 1 -10 -4 -10 -6 0 -10 -3 -9 -7 1 -5 -2 -19 -6 -33 -4 -14 -2 -38 3 -53 8 -21 17 -27 39 -27 35 0 52 19 81 84 34 79 130 215 208 297 53 55 74 85 77 108 2 17 -1 31 -6 31 -5 0 -7 4 -4 9 3 5 -8 14 -25 20 -29 10 -33 8 -110 -70z"/>
    <path d="M2745 2444 c-18 -34 -18 -36 0 -67 10 -18 22 -34 25 -37 16 -11 79 -118 73 -124 -4 -3 -1 -6 6 -6 7 0 10 -4 7 -9 -4 -5 -2 -11 3 -13 5 -1 20 -25 33 -53 20 -43 28 -50 55 -53 25 -3 35 2 48 22 16 24 16 28 -1 72 -9 25 -41 86 -70 134 -28 49 -49 92 -45 96 3 4 0 4 -6 0 -7 -4 -13 -3 -13 2 0 15 -62 72 -79 72 -9 0 -25 -16 -36 -36z"/>
    <path d="M1768 2419 c-43 -16 -49 -87 -8 -109 10 -5 58 -9 106 -9 87 1 129 -4 169 -21 11 -4 42 -16 68 -25 102 -36 253 -163 299 -249 6 -11 14 -23 18 -26 14 -10 68 -136 86 -200 33 -118 23 -379 -23 -595 -8 -38 -17 -81 -19 -95 -12 -63 -68 -263 -95 -340 -70 -193 -70 -195 -60 -223 8 -20 17 -27 38 -27 39 0 49 9 72 62 67 157 146 446 187 683 22 129 27 192 27 325 1 186 -13 257 -76 394 -20 41 -32 78 -29 82 4 4 2 5 -3 1 -11 -6 -72 82 -67 96 1 5 -2 6 -8 2 -5 -3 -10 -2 -10 4 0 12 -69 77 -135 127 -27 21 -53 43 -57 48 -4 6 -8 8 -8 4 0 -4 -30 9 -67 29 -38 20 -68 35 -68 34 0 -4 -59 11 -70 18 -27 15 -230 23 -267 10z"/>
    <path d="M1558 2360 c-2 -3 -32 -22 -68 -41 -36 -20 -92 -61 -125 -92 -33 -31 -63 -57 -67 -57 -5 0 -8 -4 -8 -10 0 -10 -20 -37 -52 -71 -9 -9 -19 -26 -23 -38 -3 -12 -11 -21 -17 -21 -6 0 -9 -3 -6 -6 3 -3 -9 -38 -28 -78 -39 -86 -53 -134 -65 -236 -25 -207 -32 -246 -60 -341 -17 -57 -33 -108 -37 -114 -4 -5 -7 -14 -8 -20 -1 -5 -9 -27 -17 -48 -9 -20 -17 -41 -18 -45 0 -4 -16 -37 -35 -73 -44 -85 -44 -112 0 -136 34 -19 56 -3 92 68 99 198 184 485 184 625 0 147 84 354 187 459 33 33 70 68 84 78 13 9 33 24 44 32 11 9 41 28 66 44 39 24 47 35 51 64 2 20 1 34 -2 32 -6 -4 -30 21 -25 27 3 2 -7 4 -20 4 -14 0 -26 -3 -27 -6z"/>
    <path d="M1790 2163 c-79 -15 -199 -69 -241 -109 -14 -13 -31 -24 -38 -24 -7 0 -10 -4 -7 -9 3 -5 -12 -25 -34 -45 -22 -20 -37 -36 -33 -36 5 0 1 -6 -7 -13 -19 -15 -53 -86 -75 -152 -9 -27 -21 -101 -26 -164 -6 -63 -19 -151 -30 -195 -11 -45 -21 -88 -23 -96 -15 -61 -30 -107 -39 -119 -7 -8 -11 -17 -10 -20 6 -14 -35 -117 -100 -249 -57 -117 -68 -146 -56 -153 28 -19 68 -39 79 -39 13 0 128 239 173 360 50 134 96 318 108 430 16 153 29 210 60 274 37 74 77 120 152 169 114 76 217 93 330 57 40 -13 86 -33 102 -44 46 -31 125 -108 125 -122 0 -7 3 -14 8 -16 15 -7 51 -96 68 -167 15 -70 15 -159 0 -262 -2 -13 -10 -61 -17 -106 -10 -68 -10 -87 0 -107 19 -34 47 -39 76 -13 20 18 28 40 40 117 25 156 30 333 11 413 -17 70 -62 171 -102 223 -13 17 -21 34 -19 38 3 3 2 4 -2 1 -11 -8 -63 47 -56 59 3 6 3 8 -2 4 -4 -4 -25 6 -46 22 -59 48 -147 83 -234 94 -16 3 -37 6 -45 9 -8 3 -49 -2 -90 -10z"/>
    <path d="M944 2019 c-36 -18 -78 -177 -94 -354 -9 -101 -28 -192 -66 -303 -22 -66 -19 -100 11 -114 48 -22 67 -1 103 108 39 122 62 230 62 293 0 60 15 146 42 239 20 69 20 75 5 108 -17 35 -28 39 -63 23z"/>
    <path d="M1790 1900 c-44 -12 -67 -28 -123 -82 -38 -36 -68 -69 -68 -72 1 -4 -5 -30 -13 -59 -8 -28 -17 -88 -20 -132 -4 -44 -15 -120 -26 -170 -11 -49 -22 -103 -26 -118 -16 -77 -103 -308 -166 -437 -39 -80 -73 -147 -77 -150 -14 -10 -33 -69 -29 -91 2 -13 15 -30 30 -38 24 -14 28 -14 48 4 49 44 163 274 236 474 62 169 123 449 124 566 0 22 9 58 19 80 74 161 286 142 343 -30 17 -50 56 -69 88 -40 25 23 25 61 1 118 -11 25 -18 48 -15 51 2 3 1 4 -2 2 -9 -7 -60 56 -56 69 2 5 0 7 -4 3 -3 -4 -18 2 -32 13 -25 19 -119 51 -157 53 -11 1 -45 -6 -75 -14z"/>
    <path d="M1827 1632 c-10 -10 -17 -33 -17 -50 0 -49 -28 -227 -51 -322 -22 -93 -68 -249 -77 -265 -4 -5 -8 -19 -9 -30 -2 -10 -10 -30 -18 -42 -9 -13 -13 -23 -11 -23 3 0 -8 -32 -25 -71 -16 -40 -29 -80 -29 -90 0 -26 28 -49 60 -49 25 0 32 7 53 53 98 209 195 562 213 775 6 67 4 86 -10 107 -20 30 -56 33 -79 7z"/>
    <path d="M2795 1614 c-14 -10 -20 -41 -31 -153 -16 -173 -37 -299 -76 -465 l-30 -128 26 -26 c25 -26 28 -26 54 -12 22 13 31 31 50 100 58 218 106 601 83 658 -14 34 -49 46 -76 26z"/>
    <path d="M2062 1514 c-7 -8 -24 -78 -38 -156 -13 -79 -30 -161 -36 -183 -6 -22 -13 -49 -15 -60 -2 -11 -9 -36 -15 -55 -7 -19 -13 -37 -13 -40 -17 -65 -29 -101 -36 -106 -5 -3 -9 -14 -9 -24 0 -17 -45 -130 -90 -225 -10 -22 -30 -66 -44 -98 -14 -32 -32 -65 -41 -74 -25 -25 -16 -94 14 -110 17 -8 31 -9 42 -2 23 12 76 107 141 251 141 314 262 827 208 879 -19 18 -52 20 -68 3z"/>
    <path d="M2244 1132 c-15 -10 -35 -49 -40 -80 -6 -31 -64 -222 -73 -237 -3 -5 -6 -16 -7 -23 -2 -8 -6 -21 -10 -30 -4 -9 -9 -26 -11 -37 -2 -10 -7 -22 -11 -25 -4 -3 -8 -12 -10 -20 -2 -8 -23 -60 -47 -115 -56 -129 -58 -139 -31 -163 33 -30 66 -15 98 43 41 76 142 335 182 471 38 127 44 179 23 204 -14 17 -47 24 -63 12z"/>
    <path d="M83 947 l-22 -12 -1 -365 c0 -201 -1 -372 -2 -380 -4 -47 3 -67 27 -78 18 -9 138 -12 400 -12 367 0 375 0 396 21 15 15 19 28 14 47 -13 53 -3 52 -376 52 l-349 0 0 335 c0 184 0 337 0 340 0 3 -6 18 -14 33 -16 30 -39 37 -73 19z"/>
    <path d="M3576 929 c-14 -24 -16 -71 -16 -367 l0 -340 -349 2 c-192 0 -348 -1 -346 -2 2 -2 -5 -12 -16 -23 -21 -21 -21 -57 0 -83 12 -14 56 -16 395 -16 329 0 385 2 404 16 l22 15 0 393 c0 422 0 425 -52 430 -19 2 -30 -4 -42 -25z"/>
    <path d="M1491 568 c-36 -72 -39 -84 -28 -102 17 -25 59 -37 79 -22 24 17 78 120 78 148 0 31 -29 58 -62 58 -22 0 -31 -12 -67 -82z"/>
  </g>
</svg>
</a>



        
        <div class="greeting-container">
            <select id="startPoint" aria-label="Выберите начальную точку">
                <option value="" disabled>Выберите начальную точку</option>
            </select>
            <button class="start-point-coords" title="Редактировать координаты начальной точки"></button>
            <select id="greeting" aria-label="Выберите приветствие">
                <option value="Moin zusammen" selected>Moin zusammen</option>
                <option value="Hallo zusammen">Hallo zusammen</option>
                <option value="Guten Morgen">Guten Morgen</option>
                <option value="Guten Tag">Guten Tag</option>
                <option value="add-new-greeting">Добавить новое приветствие</option>
            </select>
       <button class="edit-greeting-btn pencil-icon" title="Редактировать или удалить приветствие">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" width="18" height="18">
    <path
      d="M46.193 6.863a7.48 7.48 0 0 0-4.717 2.13L15.434 38.771S15.213 39.215 13.725 46.12c-.28-.074-.44-.204-.74-.267a1 1 0 0 0-.41 1.957c.305.064.452.186.73.262L11.799 55.045a1 1 0 0 0 1.38 1.125L20.553 52.9a1 1 0 0 0 .552-1.21s-.398-1.223-1.601-2.494c-.81-.855-2.192-1.688-3.883-2.404L17.113 39.9c.259-.3 20.274-23.473 25.815-29.52C47.764 5.267 55.893 14.152 52.834 17.424l-.022.023S33.986 38.92 27.871 46.266c-.79-1.355-1.806-2.557-2.826-3.433-.864-.742-1.162-.886-1.641-1.201L45.92 16.09a1 1 0 0 0-1.5-1.323L21.186 41.125a1 1 0 0 0 .24 1.521s1.084.645 2.316 1.703c1.232 1.058 2.549 2.529 3.022 3.945a1 1 0 0 0 1.722.317C33.662 42.3 54.262 18.827 54.295 18.79c3.881-4.151-1.668-11.392-7.387-11.9a7.55 7.55 0 0 0-1.715-.027zM15.203 48.752l1.035-4.795-4.527 1.998 4.492 2.797z"
      stroke="currentColor" stroke-width="2" fill="currentColor" />
  </svg>
</button>

        </div>

        <div id="participants"></div>

        <div class="button-container">
            <button class="add" title="Teilnehmer hinzufügen">
                <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 -960 960 960" width="24" fill="#e3e3e3">
                    <path
                        d="M480-80Q319-217 239.5-334.5T160-552q0-150 96.5-239T480-880h20q10 0 20 2v81q-10-2-19.5-2.5T480-800q-101 0-170.5 69.5T240-552q0 71 59 162.5T480-186q122-112 181-203.5T720-552v-8h80v8q0 100-79.5 217.5T480-80Zm0-400q33 0 56.5-23.5T560-560q0-33-23.5-56.5T480-640q-33 0-56.5 23.5T400-560q0 33 23.5 56.5T480-480Zm0-80Zm240-80h80v-120h120v-80H800v-120h-80v120H600v80h120v120Z" />
                </svg>
            </button>
            <button class="calculate" title="Berechnen">
                <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 -960 960 960" width="24" fill="#e3e3e3">
                    <path
                        d="m226-559 78 33q14-28 29-54t33-52l-56-11-84 84Zm142 83 114 113q42-16 90-49t90-75q70-70 109.5-155.5T806-800q-72-5-158 34.5T492-656q-42 42-75 90t-49 90Zm178-65q-23-23-23-56.5t23-56.5q23-23 57-23t57 23q23 23 23 56.5T660-541q-23 23-57 23t-57-23Zm19 321 84-84-11-56q-26 18-52 32.5T532-299l33 79Zm313-653q19 121-23.5 235.5T708-419l20 99q4 20-2 39t-20 33L538-80l-84-197-171-171-197-84 167-168q14-14 33.5-20t39.5-2l99 20q104-104 218-147t235-24ZM157-321q35-35 85.5-35.5T328-322q35 35 34.5 85.5T327-151q-25 25-83.5 43T82-76q14-103 32-161.5t43-83.5Zm57 56q-10 10-20 36.5T180-175q27-4 53.5-13.5T270-208q12-12 13-29t-11-29q-12-12-29-11.5T214-265Z" />
                </svg>
            </button>
            <button class="route-back" title="Маршрут назад">
                <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1"
                    width="24px" height="24px" viewBox="0 0 256 256" xml:space="preserve">
                    <g style="stroke: none; stroke-width: 0; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: none; fill-rule: nonzero; opacity: 1;"
                        transform="translate(1.4065934065934016 1.4065934065934016) scale(2.81 2.81)">
                        <path
                            d="M 77.612 90 H 12.388 c -0.829 0 -1.5 -0.672 -1.5 -1.5 V 36.637 H 1.5 c -0.642 0 -1.212 -0.408 -1.419 -1.015 c -0.208 -0.607 -0.006 -1.279 0.502 -1.671 l 43.5 -33.637 c 0.54 -0.418 1.295 -0.418 1.835 0 l 43.5 33.637 c 0.507 0.393 0.709 1.064 0.502 1.671 c -0.208 0.607 -0.778 1.015 -1.42 1.015 h -9.388 V 88.5 C 79.112 89.328 78.44 90 77.612 90 z M 13.888 87 h 62.225 V 35.137 c 0 -0.829 0.672 -1.5 1.5 -1.5 h 6.496 L 45 3.396 L 5.892 33.637 h 6.496 c 0.829 0 1.5 0.671 1.5 1.5 V 87 z"
                            style="stroke: #e3e3e3; stroke-width: 3; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: #e3e3e3; fill-rule: nonzero; opacity: 1;"
                            transform="matrix(1 0 0 1 0 0)" stroke-linecap="round" />
                        <path
                            d="M 45 81.51 L 30.514 64.449 C 27.603 61.019 26 56.657 26 52.169 c 0 -10.477 8.523 -19 19 -19 s 19 8.523 19 19 c 0 4.489 -1.603 8.851 -4.514 12.28 L 45 81.51 z M 45 36.169 c -8.822 0 -16 7.177 -16 16 c 0 3.778 1.35 7.45 3.801 10.339 L 45 76.875 l 12.199 -14.367 C 59.65 59.619 61 55.948 61 52.169 C 61 43.347 53.822 36.169 45 36.169 z M 45 60.264 c -4.795 0 -8.697 -3.901 -8.697 -8.696 c 0 -4.796 3.901 -8.697 8.697 -8.697 c 4.796 0 8.697 3.901 8.697 8.697 C 53.697 56.362 49.796 60.264 45 60.264 z M 45 45.87 c -3.141 0 -5.697 2.556 -5.697 5.697 c 0 3.141 2.556 5.696 5.697 5.696 c 3.142 0 5.697 -2.556 5.697 -5.696 C 50.697 48.426 48.142 45.87 45 45.87 z"
                            style="stroke: #e3e3e3; stroke-width: 3; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: #e3e3e3; fill-rule: nonzero; opacity: 1;"
                            transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round" />
                    </g>
                </svg>
            </button>
          <button class="copy" title="Kopieren" aria-label="Kopieren">

                <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 -960 960 960" width="24" fill="#e3e3e3">
                    <path
                        d="M360-240q-33 0-56.5-23.5T280-320v-480q0-33 23.5-56.5T360-880h360q33 0 56.5 23.5T800-800v480q0 33-23.5 56.5T720-240H360Zm0-80h360v-480H360v480ZM200-80q-33 0-56.5-23.5T120-160v-560h80v560h440v80H200Zm160-240v-480 480Z" />
                </svg>
            </button>
            <button class="clear" title="Сбросить данные">
                <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1"
                    width="24px" height="24px" viewBox="0 0 256 256" xml:space="preserve">
                    <g style="stroke: none; stroke-width: 0; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: none; fill-rule: nonzero; opacity: 1;"
                        transform="translate(1.4065934065934016 1.4065934065934016) scale(2.81 2.81)">
                        <path
                            d="M 7.288 48.34 c 0.061 0.04 0.129 0.068 0.193 0.105 c 0.18 0.105 0.363 0.201 0.559 0.277 c 0.093 0.036 0.19 0.06 0.286 0.089 c 0.175 0.053 0.351 0.098 0.535 0.127 c 0.049 0.008 0.094 0.028 0.144 0.034 C 9.164 48.99 9.322 49 9.481 49 c 0 0 0 0 0.001 0 c 0 0 0 0 0 0 c 0 0 0 0 0 0 c 0.267 0 0.531 -0.028 0.79 -0.08 c 0.154 -0.031 0.297 -0.086 0.443 -0.134 c 0.101 -0.033 0.206 -0.054 0.304 -0.094 c 0.162 -0.067 0.31 -0.158 0.46 -0.245 c 0.075 -0.043 0.156 -0.075 0.228 -0.124 c 0.217 -0.146 0.42 -0.311 0.604 -0.495 c 0 0 0 0 0 0 l 7.492 -7.492 c 1.562 -1.562 1.562 -4.095 0 -5.657 c -1.149 -1.149 -2.822 -1.445 -4.249 -0.903 c 4.535 -11.868 16.033 -20.322 29.475 -20.322 c 12.266 0 23.516 7.2 28.658 18.342 c 0.926 2.004 3.3 2.881 5.309 1.956 c 2.005 -0.926 2.881 -3.302 1.955 -5.308 C 74.503 14.478 60.403 5.455 45.027 5.455 c -17.837 0 -32.947 11.873 -37.859 28.129 c -1.224 -1.611 -3.48 -2.084 -5.247 -1.008 c -1.887 1.148 -2.486 3.609 -1.338 5.496 l 5.481 9.007 c 0.014 0.023 0.035 0.041 0.049 0.063 c 0.125 0.195 0.268 0.375 0.424 0.545 c 0.036 0.039 0.064 0.085 0.101 0.122 C 6.835 48.009 7.053 48.186 7.288 48.34 z"
                            style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill:#e3e3e3; fill-rule: nonzero; opacity: 1;"
                            transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round" />
                        <path
                            d="M 89.416 51.929 l -5.48 -9.008 c -0.014 -0.023 -0.035 -0.04 -0.049 -0.063 c -0.125 -0.195 -0.268 -0.375 -0.424 -0.546 c -0.035 -0.039 -0.063 -0.084 -0.1 -0.121 c -0.197 -0.199 -0.415 -0.376 -0.65 -0.531 c -0.061 -0.04 -0.129 -0.067 -0.192 -0.104 c -0.18 -0.105 -0.364 -0.201 -0.56 -0.277 c -0.093 -0.036 -0.19 -0.06 -0.287 -0.089 c -0.174 -0.053 -0.35 -0.098 -0.534 -0.127 c -0.049 -0.008 -0.095 -0.028 -0.144 -0.034 c -0.07 -0.008 -0.138 0.003 -0.208 -0.001 C 80.697 41.021 80.611 41 80.519 41 c -0.082 0 -0.159 0.019 -0.239 0.024 c -0.121 0.007 -0.24 0.018 -0.36 0.036 c -0.172 0.026 -0.338 0.065 -0.503 0.113 c -0.105 0.03 -0.209 0.058 -0.312 0.097 c -0.178 0.067 -0.344 0.152 -0.509 0.243 c -0.082 0.045 -0.166 0.082 -0.245 0.133 c -0.237 0.153 -0.46 0.326 -0.659 0.524 c 0 0 -0.001 0.001 -0.001 0.001 l 0 0 l 0 0 l -7.492 7.492 c -1.562 1.562 -1.562 4.095 0 5.656 c 1.148 1.15 2.822 1.446 4.249 0.904 c -4.535 11.868 -16.033 20.321 -29.475 20.321 c -12.707 0 -24.117 -7.563 -29.068 -19.268 c -0.861 -2.034 -3.209 -2.988 -5.242 -2.125 c -2.035 0.86 -2.986 3.207 -2.126 5.242 c 6.206 14.671 20.508 24.151 36.436 24.151 c 17.831 0 32.937 -11.864 37.854 -28.111 c 0.774 1.015 1.96 1.574 3.176 1.574 c 0.708 0 1.426 -0.188 2.075 -0.584 C 89.966 56.276 90.565 53.816 89.416 51.929 z"
                            style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill:#e3e3e3; fill-rule: nonzero; opacity: 1;"
                            transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round" />
                    </g>
                </svg>
            </button>
        </div>



        <pre id="output"></pre>
        <div id="toast" class="toast"></div>

        <div id="coordsModal" class="modal">
          <div class="modal-content" id="modalContent"
     style="background: var(--modal-bg, #fff) !important; color: var(--modal-text, #000) !important;">

                <h3 id="modalTitle">Редактировать координаты</h3>
                <label id="nameLabel" style="display:none">Имя:</label>
                <input type="text" id="nameInput" style="display:none" placeholder="Введите имя" />
                <label id="greetingLabel" style="display:none">Приветствие:</label>
                <input type="text" id="greetingInput" style="display:none" placeholder="Введите приветствие" />
                <label id="coordsLabel" style="display:none">Введите координаты<br>(широта,долгота или URL Google
                    Карт):</label>
                <input type="text" id="coordsInput" style="display:none"
                    placeholder="51.452013,7.021455 или https://maps.app.goo.gl/..." />
                <p id="coordsHelp" style="display:none;color:#d32f2f;font-weight:bold">Сокращённые ссылки обрабатываются
                    несколько секунд.</p>
                    
<select id="stationSelect" style="display:none; margin-top:6px; width:100%; padding:var(--small-spacing); border:1px solid #ddd; border-radius:4px; font-size:1em; box-sizing:border-box; background:var(--surface); color:var(--text);">

  <option value="">– Выбрать из списка –</option>
</select>

                    
                <button class="map-button" id="openMap" style="display:none">
                    <svg width="24" height="24" viewBox="0 0 90 90" fill="currentColor">
                        <path
                            d="M89 79.382H1c-.355 0-.683-.188-.863-.494-.179-.306-.183-.685-.01-.994L15.174 49.373c.177-.315.511-.512.873-.512h22.326c.552 0 1 .447 1 1s-.448 1-1 1H17.534L2.705 77.382h84.59L72.466 50.86H50.728c-.553 0-1-.447-1-1s.447-1 1-1h22.325c.362 0 .696.196.873.512l15.947 28.521c.173.31.169.688-.011.994s-.778.484-1.132.484z" />
                        <path
                            d="M45 60.554L30.514 43.493C27.603 40.063 26 35.701 26 31.213c0-10.477 8.523-19 19-19s19 8.523 19 19c0 4.489-1.603 8.851-4.514 12.28L45 60.554zM45 15.713c-8.28 0-15.016 6.736-15.016 15.016 0 3.778 1.35 7.45 3.801 10.339L45 45.875l12.199-14.367C59.65 38.619 61 34.948 61 31.169c0-8.822-7.177-16-16-16z" />
                        <path
                            d="M45.024 35.998c-4.769 0-8.649-3.88-8.649-8.649s3.88-8.649 8.649-8.649 8.649 3.88 8.649 8.649-3.88 8.649-8.649 8.649zm0-15.298c-3.666 0-6.649 2.983-6.649 6.649s2.983 6.649 6.649 6.649 6.649-2.983 6.649-6.649-2.983-6.649-6.649-6.649z" />
                        <path
                            d="M1 79.382c-.441 0-.845-.294-.965-.74-.143-.533.173-1.082.706-1.226l76.501-20.565c.531-.145 1.082.172 1.226.706.144.533-.173 1.082-.706 1.226L1.26 79.348c-.087.023-.175.034-.26.034z" />
                        <path
                            d="M63.521 73.279c-.286 0-.569-.121-.767-.357l-7.332-8.733c-.355-.423-.301-1.054.123-1.408.423-.355 1.056-.301 1.408.123l7.332 8.733c.355.423.301 1.054-.123 1.408-.247.202-.476.279-.703.279z" />
                        <path
                            d="M34.419 70.398c-.285 0-.568-.121-.766-.357L23.606 58.075c-.355-.423-.3-1.054.123-1.408.424-.354 1.054-.301 1.409.123l10.047 11.966c.355.423.3 1.054-.123 1.408-.247.202-.476.279-.703.279z" />
                    </svg>
                </button>
                <div class="modal-buttons">
                <button class="modal-btn save-button"   id="saveCoords">Сохранить</button>
<button class="modal-btn cancel-button" id="cancelCoords">Отмена</button>
<button class="modal-btn delete-greeting-btn" id="deleteGreeting">Удалить</button>

                </div>
            </div>
        </div>
    </main>

    <script>
        "use strict";
        class FahrzeitRechner {
            constructor() {
                this.defaultGreetings = ['Moin zusammen', 'Hallo zusammen', 'Guten Morgen', 'Guten Tag'];
                this.greetings = [...this.defaultGreetings];
                this.greeting = 'Moin zusammen';
                
                




// реестр имен
const defaultCoords = {
  'Sergii': {lat:51.530133, lng:6.850858},
  'Anatolii': {lat:51.522694, lng:6.858944},
  'Andrii': {lat:51.534558, lng:6.861061},
  'Sergio': {lat:51.52, lng:6.887619},
  'Dima': {lat:51.551753, lng:7.102285},
  'René': {lat:51.476281, lng:6.861856},
  'OLGA-Park': {lat:51.5004335, lng:6.8686337},
  'Marvin': {lat:51.556472, lng:6.731424},
  'Vasyl': {lat:51.515355, lng:6.893655}
};

// реестр станций
this.stations = {
  'Gelsenkirchen-Bismarck': {lat:51.538627, lng:7.108037},
  'Hagen': {lat:51.373517, lng:7.461144},
  'Essen West': {lat:51.4539273, lng:6.9794622}
};

// Время в пути между участниками
this.travelTimes = {
  'Sergii-Anatolii': 5,
  'Sergii-Andrii': 5,
  'Sergii-Sergio': 10,
  'Sergii-Dima': 30,
  'Andrii-Anatolii': 5,
  'Andrii-Sergio': 10,
  'Andrii-Dima': 25,
  'Anatolii-Sergio': 10,
  'Anatolii-Dima': 30,
  'Sergio-Dima': 25,
  'Marvin-Sergii': 20,
  'Marvin-Anatolii': 17,
  'Marvin-Andrii': 20,
  'Marvin-Sergio': 25,
  'Marvin-Dima': 30,
  'Maikel-Sergii': 20,
  'Maikel-Andrii': 20,
  'Maikel-Anatolii': 15,
  'Maikel-Sergio': 20,
  'Maikel-Dima': 30,
  'Maikel-Marvin': 5,
  'René-Sergii': 15,
  'René-Andrii': 15,
  'René-Anatolii': 10,
  'René-Sergio': 15,
  'René-Dima': 25,
  'René-Marvin': 25,
  'René-Maikel': 25,
  'Vasyl-Sergii': 10,
  'Vasyl-Andrii': 10,
  'Vasyl-Anatolii': 10,
  'Vasyl-Sergio': 5,
  'Vasyl-Dima': 20,
  'Vasyl-Marvin': 25,
  'Vasyl-Maikel': 25,
  'Vasyl-René': 25,
  'OLGA-Park-Sergii': 10,
  'OLGA-Park-Andrii': 10,
  'OLGA-Park-Anatolii': 10,
  'OLGA-Park-Sergio': 10,
  'OLGA-Park-Dima': 20,
  'OLGA-Park-Marvin': 20,
  'OLGA-Park-Maikel': 20,
  'OLGA-Park-René': 5,
  'OLGA-Park-Vasyl': 10
};

// Приоритетные списки остановок
this.participantOrders = {
  'Sergii': ['Anatolii', 'Andrii', 'Sergio', 'Dima'],
  'Anatolii': ['Sergii', 'Andrii', 'Sergio', 'Vasyl', 'OLGA-Park'],
  'Andrii': ['Sergii', 'Anatolii', 'Sergio', 'Dima'],
  'Sergio': ['Anatolii', 'Sergii', 'Andrii', 'Dima'],
  'Dima': ['Anatolii', 'Sergii', 'Andrii', 'Sergio']
};
                
                this.startPoint = '';
                this.startPointCoords = { lat: null, lng: null };

    this.defaultCoordinates = defaultCoords;      // для сброса
    this.nameToCoordinates = { ...defaultCoords }; 
    
                this.participants = [];
                this.machineStop = { name: "an der Maschine", time: 20, arrivalTime: "", lat: null, lng: null };
                this.useUhrBei = false;
                this.useSuperscriptTime = false;
                this.sortable = null;

                this.elements = {
                    greetingSelect: document.getElementById('greeting'),
                    editGreetingButton: document.querySelector('.edit-greeting-btn'),
                    startPointSelect: document.getElementById('startPoint'),
                    startPointCoordsButton: document.querySelector('.start-point-coords'),
                    participantsContainer: document.getElementById('participants'),
                    addButton: document.querySelector('.add'),
                    calculateButton: document.querySelector('.calculate'),
                    routeBackButton: document.querySelector('.route-back'),
                    copyButton: document.querySelector('.copy'),
                    clearButton: document.querySelector('.clear'),
                    output: document.getElementById('output'),
                    toast: document.getElementById('toast'),
                    coordsModal: document.getElementById('coordsModal'),
                    modalContent: document.querySelector('.modal-content'),
                    coordsInput: document.getElementById('coordsInput'),
                    coordsLabel: document.getElementById('coordsLabel'),
                    coordsHelp: document.getElementById('coordsHelp'),
                    nameInput: document.getElementById('nameInput'),
                    nameLabel: document.getElementById('nameLabel'),
                    greetingInput: document.getElementById('greetingInput'),
                    greetingLabel: document.getElementById('greetingLabel'),
                    modalTitle: document.getElementById('modalTitle'),
                    saveCoordsButton: document.getElementById('saveCoords'),
                    deleteGreetingButton: document.getElementById('deleteGreeting'),
                    cancelCoordsButton: document.getElementById('cancelCoords'),
                    openMapButton: document.getElementById('openMap')
                };
                this.currentEditIndex = null;
                this.isEditingMachine = false;
                this.isAddingNewName = false;
                this.isAddingNewGreeting = false;
                this.isEditingGreeting = false;
                this.isEditingStartPoint = false;

                this.loadData();
                this.syncCoordinates();
                this.addEventListeners();
                this.renderParticipants();
                this.elements.output.innerHTML = '';
            }

            getTravelTime(fromName, toName) {
  if (fromName === toName) return 0;
  const key = `${fromName}-${toName}`;
  const rev = `${toName}-${fromName}`;
  return this.travelTimes[key] ?? this.travelTimes[rev] ?? 5; // 5 – fallback
}


            updateParticipantTimes() {
                let previousPoint = this.startPoint;
                this.participants.forEach(participant => {
                    if (participant.name && !participant.timeManuallyEdited) {
                        participant.time = this.getTravelTime(previousPoint, participant.name);
                    }
                    if (participant.name) previousPoint = participant.name;
                });
            }

            syncCoordinates() {
                this.participants.forEach(p => {
                    const coords = this.nameToCoordinates[p.name];
                    if (coords) { p.lat = coords.lat; p.lng = coords.lng; }
                });
                const startCoords = this.nameToCoordinates[this.startPoint];
                this.startPointCoords = startCoords ? { lat: startCoords.lat, lng: startCoords.lng } : { lat: null, lng: null };
            }

            saveData() {
                localStorage.setItem('fahrzeitRechnerGreeting', this.greeting);
                localStorage.setItem('fahrzeitRechnerGreetings', JSON.stringify(this.greetings));
                localStorage.setItem('fahrzeitRechnerParticipants', JSON.stringify(this.participants));
                localStorage.setItem('fahrzeitRechnerMachineStop', JSON.stringify(this.machineStop));
                localStorage.setItem('fahrzeitRechnerNameToCoordinates', JSON.stringify(this.nameToCoordinates));
                localStorage.setItem('fahrzeitRechnerStartPoint', this.startPoint);
                localStorage.setItem('fahrzeitRechnerUseUhrBei', this.useUhrBei);
                localStorage.setItem('fahrzeitRechnerUseSuperscript', this.useSuperscriptTime);
            }

            resetToDefaults() {
  this.greeting = 'Moin zusammen';
  this.greetings = [...this.defaultGreetings];
  this.startPoint = '';
  this.startPointCoords = { lat: null, lng: null };
  this.participants = [];
  this.nameToCoordinates = { ...this.defaultCoordinates }; 
  this.machineStop = { name: "an der Maschine", time: 20, arrivalTime: "", lat: null, lng: null };
  this.useUhrBei = false;
  this.useSuperscriptTime = false;
  this.saveData();
}


            clearLocalStorage() {
                ['fahrzeitRechnerGreeting', 'fahrzeitRechnerGreetings', 'fahrzeitRechnerParticipants',
                    'fahrzeitRechnerMachineStop', 'fahrzeitRechnerNameToCoordinates', 'fahrzeitRechnerStartPoint',
                    'fahrzeitRechnerUseSuperscript'].forEach(k => localStorage.removeItem(k));
                this.showToast("Данные сброшены.");
                this.resetToDefaults();
                this.elements.output.innerHTML = '';
                this.renderParticipants();
                this.initSortable();
            }

            loadData() {
                try {
                    const saved = {
                        greeting: localStorage.getItem('fahrzeitRechnerGreeting'),
                        greetings: localStorage.getItem('fahrzeitRechnerGreetings'),
                        participants: localStorage.getItem('fahrzeitRechnerParticipants'),
                        machineStop: localStorage.getItem('fahrzeitRechnerMachineStop'),
                        nameToCoordinates: localStorage.getItem('fahrzeitRechnerNameToCoordinates'),
                        startPoint: localStorage.getItem('fahrzeitRechnerStartPoint'),
                        useUhrBei: localStorage.getItem('fahrzeitRechnerUseUhrBei'),
                        useSuperscript: localStorage.getItem('fahrzeitRechnerUseSuperscript')
                    };
                    if (saved.greeting) this.greeting = saved.greeting;
                    if (saved.greetings) try { this.greetings = JSON.parse(saved.greetings); } catch { this.greetings = [...this.defaultGreetings]; }
                    if (saved.participants) try { this.participants = JSON.parse(saved.participants).map(p => ({ ...p, timeManuallyEdited: p.timeManuallyEdited || false })); } catch { this.participants = []; }
                    if (saved.machineStop) try { this.machineStop = JSON.parse(saved.machineStop); } catch { this.machineStop = { name: "an der Maschine", time: 20, arrivalTime: "", lat: null, lng: null }; }
                    if (saved.nameToCoordinates) try { this.nameToCoordinates = JSON.parse(saved.nameToCoordinates); } catch { /* use default */ }
                    if (saved.startPoint) {
                        this.startPoint = saved.startPoint;
                        const startCoords = this.nameToCoordinates[this.startPoint];
                        this.startPointCoords = startCoords ? { lat: startCoords.lat, lng: startCoords.lng } : { lat: null, lng: null };
                    }
                    if (saved.useUhrBei !== null) this.useUhrBei = saved.useUhrBei === 'true';
                    if (saved.useSuperscript !== null) this.useSuperscriptTime = saved.useSuperscript === 'true';
                } catch {
                    this.resetToDefaults();
                }
                this.updateStartPoint(this.startPoint);
            }

            addEventListeners() {
                this.elements.greetingSelect.addEventListener('change', e => {
                    if (e.target.value === 'add-new-greeting') this.openGreetingModal(true);
                    else { this.greeting = e.target.value; this.saveData(); this.calculate(); }
                });
                this.elements.editGreetingButton.addEventListener('click', () => this.openGreetingModal(false));
                this.elements.startPointSelect.addEventListener('change', e => this.updateStartPoint(e.target.value));
                this.elements.startPointCoordsButton.addEventListener('click', () => this.openCoordsModal(null, false, false, true));
                this.elements.addButton.addEventListener('click', () => this.addParticipant());
                this.elements.calculateButton.addEventListener('click', () => this.openGoogleMaps());
                this.elements.routeBackButton.addEventListener('click', () => this.openGoogleMaps(true));
                this.elements.copyButton.addEventListener('click', () => this.copyResult());
                this.elements.clearButton.addEventListener('click', () => this.clearLocalStorage());
                this.elements.saveCoordsButton.addEventListener('click', () => this.saveCoordinates());
                this.elements.deleteGreetingButton.addEventListener('click', () => this.deleteGreeting());
                this.elements.cancelCoordsButton.addEventListener('click', () => this.closeModal());
                this.elements.openMapButton.addEventListener('click', () => this.openMapForSelection());
            }

            updateStartPoint(value) {
                if (value === 'add-new') {
                    this.openCoordsModal(null, false, true, true);
                } else {
                    this.startPoint = value;
                    const startCoords = this.nameToCoordinates[value];
                    this.startPointCoords = startCoords ? { lat: startCoords.lat, lng: startCoords.lng } : { lat: null, lng: null };
                    const order = this.participantOrders[value] || [];
                    this.participants = order.map((name, idx) => {
                        const coords = this.nameToCoordinates[name] || { lat: null, lng: null };
                        const prev = idx === 0 ? this.startPoint : order[idx - 1];
                        return {
                            name,
                            time: this.getTravelTime(prev, name),
                            lat: coords.lat,
                            lng: coords.lng,
                            timeManuallyEdited: false
                        };
                    });
                    this.updateParticipantTimes();
                    this.saveData();
                    this.renderParticipants();
                    this.initSortable();
                    this.calculate();
                }
            }

            renderParticipants() {
                const container = this.elements.participantsContainer;
                container.innerHTML = '';
                this.elements.greetingSelect.innerHTML = this.greetings.map(g => `<option value="${g}" ${this.greeting === g ? 'selected' : ''}>${g}</option>`).join('') + '<option value="add-new-greeting">Добавить новое приветствие</option>';
                const nameOptions = Object.keys(this.nameToCoordinates).map(name => `<option value="${name}" ${this.startPoint === name ? 'selected' : ''}>${name}</option>`).join('');
                this.elements.startPointSelect.innerHTML = `
            <option value="" ${!this.startPoint ? 'selected' : ''}>Выберите начальную точку</option>
            ${nameOptions}
            <option value="add-new">Добавить новое имя</option>
        `;
                const noCoordsSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="rgb(209,43,47)"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>`;
                const hasCoordsSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="rgb(68,178,229)"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>`;
                this.elements.startPointCoordsButton.innerHTML = (this.startPointCoords.lat && this.startPointCoords.lng) ? hasCoordsSvg : noCoordsSvg;

                const validNames = this.participants.map(p => p.name).filter(n => n);
                if (this.startPoint && validNames.includes(this.startPoint)) {
                    this.showToast(`Начальная точка "${this.startPoint}" не может совпадать с именем участника.`);
                    this.startPoint = ''; this.startPointCoords = { lat: null, lng: null };
                    this.participants = []; this.saveData();
                }

                this.participants.forEach((p, i) => {
                    const div = document.createElement('div');
                    div.className = 'participant';
                    div.setAttribute('data-index', i);
                    const participantNameOptions = Object.keys(this.nameToCoordinates).filter(n => n !== this.startPoint)
                        .map(n => `<option value="${n}" ${p.name === n ? 'selected' : ''}>${n}</option>`).join('');
                    const coordsSvg = (p.lat && p.lng) ? hasCoordsSvg : noCoordsSvg;
                    div.innerHTML = `
                <select data-index="${i}" data-type="participant-name" aria-label="Имя участника">
                    <option value="" ${!p.name ? 'selected' : ''}>Выберите имя</option>
                    ${participantNameOptions}
                    <option value="add-new">Добавить новое имя</option>
                </select>
                <button class="coords-icon" data-index="${i}" data-type="participant-coords" aria-label="Редактировать координаты участника">${coordsSvg}</button>
                <input type="number" value="${p.time}" min="1" max="60" data-index="${i}" data-type="participant-time" aria-label="Время поездки к участнику в минутах"/>
                <div class="right-section">
                    <span class="material-symbols-outlined" aria-label="Переместить участника">
                        <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 -960 960 960" width="24" fill="#e3e3e3"><path d="M320-440v-287L217-624l-57-56 200-200 200 200-57 56-103-103v287h-80ZM600-80 400-280l57-56 103 103v-287h80v287l103-103 57 56L600-80Z"/></svg>
                    </span>
                    <button class="remove-btn" data-index="${i}" aria-label="Удалить участника">✖</button>
                </div>
            `;
                    container.appendChild(div);
                    div.querySelector('[data-type="participant-name"]').addEventListener('change', e => this.updateName(i, e.target.value));
                    div.querySelector('[data-type="participant-time"]').addEventListener('change', e => this.updateTime(i, e.target.value));
                    div.querySelector('[data-type="participant-coords"]').addEventListener('click', () => this.openCoordsModal(i));
                    div.querySelector('.remove-btn').addEventListener('click', () => this.removeParticipant(i));
                });

                const machineDiv = document.createElement('div');
                machineDiv.className = 'participant machine';
                const machineCoordsSvg = (this.machineStop.lat && this.machineStop.lng) ? hasCoordsSvg : noCoordsSvg;

                machineDiv.innerHTML = `
    <input type="text" value="${this.machineStop.name}" data-type="machine-name" aria-label="Название остановки машины"/>
    <button class="coords-icon" data-type="machine-coords" aria-label="Редактировать координаты машины">${machineCoordsSvg}</button>
    <input type="number" value="${this.machineStop.time}" min="1" max="60" data-type="machine-time" aria-label="Время на остановке машины в минутах"/>
    <div class="right-section">
        ${this.machineStop.arrivalTime
                        ? `<div class="arrival-time" tabindex="0" role="button" aria-label="Изменить время прибытия">${this.machineStop.arrivalTime}</div><button class="time-remove" aria-label="Очистить время прибытия">✖</button>`
                        : '<button class="time-icon" aria-label="Установить время прибытия">🕒</button>'
                    }
    </div>
`;

                container.appendChild(machineDiv);
                machineDiv.querySelector('[data-type="machine-name"]').addEventListener('change', e => this.updateMachineName(e.target.value));
                machineDiv.querySelector('[data-type="machine-time"]').addEventListener('change', e => this.updateMachineTime(e.target.value));
                machineDiv.querySelector('[data-type="machine-coords"]').addEventListener('click', () => this.openCoordsModal(null, true));

                container.appendChild(machineDiv);

                // Добавляем новый контейнер для чекбоксов
                const checkboxContainer = document.createElement('div');
                checkboxContainer.className = 'checkbox-container';
                checkboxContainer.innerHTML = `
    <label>
        <input type="checkbox" id="useUhrBei" ${this.useUhrBei ? 'checked' : ''}> um...Uhr bei
    </label>
    <label>
        <input type="checkbox" id="useSuperscriptTime" ${this.useSuperscriptTime ? 'checked' : ''}> X²
    </label>
    <label class="theme-toggle">


`;
                container.appendChild(checkboxContainer);

                // Обработчики событий для чекбоксов
                const uhrBeiCheckbox = checkboxContainer.querySelector('#useUhrBei');
                uhrBeiCheckbox.addEventListener('change', () => {
                    this.useUhrBei = uhrBeiCheckbox.checked;
                    this.saveData();
                    this.calculate();
                });
                const superscriptCheckbox = checkboxContainer.querySelector('#useSuperscriptTime');
                superscriptCheckbox.addEventListener('change', () => {
                    this.useSuperscriptTime = superscriptCheckbox.checked;
                    this.saveData();
                    this.calculate();
                });

                const timeControl = machineDiv.querySelector('.time-icon') || machineDiv.querySelector('.arrival-time');
                timeControl.addEventListener('click', () => this.startTimeEdit());
                timeControl.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        this.startTimeEdit();
                    }
                });
                const timeRemoveBtn = machineDiv.querySelector('.time-remove');
                if (timeRemoveBtn) timeRemoveBtn.addEventListener('click', () => this.clearArrivalTime());
                this.saveData();
                if (this.machineStop.arrivalTime) this.calculate(); else this.elements.output.innerHTML = '';
            }

            async parseCoordinates(raw) {
                const s = raw.trim();
                if (!s) { this.showToast("Пожалуйста, введите данные."); return null; }
                
                
                // 1. «51,123456, 7,123456» — дробь через ЗАПЯТУЮ
if (/^-?\d{1,2},\d+\s*,\s*-?\d{1,3},\d+$/.test(s)) {
  const parts = s.split(',').map(p => p.trim());
  const lat = parseFloat(parts[0] + '.' + parts[1]);
  const lng = parseFloat(parts[2] + '.' + parts[3]);
  if (Math.abs(lat) <= 90 && Math.abs(lng) <= 180) return { lat, lng };
}

// 2. «51.123456, 7.123456» — дробь через ТОЧКУ 
if (/^-?\d{1,2}(?:\.\d+)?\s*,\s*-?\d{1,3}(?:\.\d+)?$/.test(s)) {
  const [l, ln] = s.split(',').map(Number);
  if (Math.abs(l) <= 90 && Math.abs(ln) <= 180) return { lat: l, lng: ln };
}

                const m1 = s.match(/@(-?\d+\.\d+),(-?\d+\.\d+)/) || s.match(/ll=(-?\d+\.\d+),(-?\d+\.\d+)/) || s.match(/place\/[^\/]+\/(-?\d+\.\d+),(-?\d+\.\d+)/);
                if (m1) {
                    const lat = parseFloat(m1[1]), lng = parseFloat(m1[2]);
                    if (Math.abs(lat) <= 90 && Math.abs(lng) <= 180) return { lat, lng };
                }
                const dms = [...s.matchAll(/(\d{1,3})°(\d{1,2})'(\d{1,2}(?:\.\d+)?)"?\s*([NSEW])/gi)];
                if (dms.length === 2) {
                    try {
                        const toDec = ([, d, mi, s, dir]) => {
                            let dec = +d + mi / 60 + s / 3600;
                            if (/S|W/i.test(dir)) dec = -dec;
                            return dec;
                        };
                        const lat = toDec(dms[0]), lng = toDec(dms[1]);
                        if (Math.abs(lat) <= 90 && Math.abs(lng) <= 180) return { lat, lng };
                    } catch { }
                }
                if (/^https?:\/\/(?:[^/]*\.)?goo\.gl\/|https?:\/\/maps\.app\.goo\.gl\/|https?:\/\/(?:www\.)?googleusercontent\.com\/maps\.google\.com\//i.test(s)) {

                    try {
                        const url = await this.expand(s);
                        let coords = this.parseCoords(url);
                        if (!coords) coords = await this.coordsFromHTML(url);
                        if (!coords) { this.showToast("Не удалось извлечь координаты из ссылки."); return null; }
                        return coords;
                    } catch {
                        this.showToast("Ошибка при обработке сокращённой ссылки.");
                        return null;
                    }
                }
                if (!/^https?:\/\//.test(s)) {
                    const coords = this.parseCoords(s);
                    if (coords) return coords;
                }
                if (/^https?:\/\//.test(s)) {
                    try {
                        const coords = await this.coordsFromHTML(s);
                        if (coords) return coords;
                    } catch {
                        this.showToast("Не удалось извлечь координаты из ссылки.");
                        return null;
                    }
                }
                this.showToast("Пожалуйста, введите корректные координаты или URL Google Карт.");
                return null;
            }

            async expand(shortUrl) {
                const api = 'https://r.jina.ai/' + shortUrl.replace(/^https?:\/\//, '');
                const response = await fetch(api);
                if (!response.ok) throw new Error('Не удалось раскрыть ссылку');
                const raw = await response.text();
                try {
                    const json = JSON.parse(raw);
                    if (json.resolved_url) return json.resolved_url;
                } catch { }
                const match = raw.match(/https?:\/\/[^\s"']+/);
                if (match) return match[0];
                throw new Error('Сервис не вернул URL');
            }

            parseCoords(str) {
                let m = str.match(/([-+]?\d{1,3}\.\d+)[ ,]+([-+]?\d{1,3}\.\d+)/);
                if (m) {
                    const lat = +m[1], lng = +m[2];
                    if (Math.abs(lat) <= 90 && Math.abs(lng) <= 180) return { lat, lng };
                }
                m = str.match(/@([-.\d]+),([-.\d]+),/);
                if (m) {
                    const lat = +m[1], lng = +m[2];
                    if (Math.abs(lat) <= 90 && Math.abs(lng) <= 180) return { lat, lng };
                }
                m = str.match(/\/place\/([-.\d]+),([-.\d]+)/);
                if (m) {
                    const lat = +m[1], lng = +m[2];
                    if (Math.abs(lat) <= 90 && Math.abs(lng) <= 180) return { lat, lng };
                }
                m = str.match(/(?:dest|query|center)=([-.\d]+),([-.\d]+)/);
                if (m) {
                    const lat = +m[1], lng = +m[2];
                    if (Math.abs(lat) <= 90 && Math.abs(lng) <= 180) return { lat, lng };
                }
                return null;
            }

            async coordsFromHTML(page) {
                const api = 'https://r.jina.ai/' + page.replace(/^https?:\/\//, '');
                const response = await fetch(api);
                if (!response.ok) return null;
                const text = await response.text();
                let m = text.match(/"lat"\s*:\s*([-.\d]+)\s*,\s*"lng"\s*:\s*([-.\d]+)/);
                if (m) {
                    const lat = +m[1], lng = +m[2];
                    if (Math.abs(lat) <= 90 && Math.abs(lng) <= 180) return { lat, lng };
                }
                m = text.match(/https?:\/\/[^"' ]+\?q=([-.\d]+),([-.\d]+)/);
                if (m) {
                    const lat = +m[1], lng = +m[2];
                    if (Math.abs(lat) <= 90 && Math.abs(lng) <= 180) return { lat, lng };
                }
                m = text.match(/([-+]?\d{1,3}\.\d{4,}),\s*([-+]?\d{1,3}\.\d{4,})/);
                if (m) {
                    const lat = +m[1], lng = +m[2];
                    if (Math.abs(lat) <= 90 && Math.abs(lng) <= 180) return { lat, lng };
                }
                return null;
            }

            openCoordsModal(index, isMachine = false, isAddingNewName = false, isEditingStartPoint = false) {
                this.currentEditIndex = index;
                this.isEditingMachine = isMachine;
                this.isAddingNewName = isAddingNewName;
                this.isEditingStartPoint = isEditingStartPoint;
                this.isAddingNewGreeting = false;
                this.isEditingGreeting = false;
                const modal = this.elements.coordsModal;
                const modalContent = this.elements.modalContent;
                const coordsInput = this.elements.coordsInput;
                const coordsLabel = this.elements.coordsLabel;
                const coordsHelp = this.elements.coordsHelp;
                const nameInput = this.elements.nameInput;
                const nameLabel = this.elements.nameLabel;
                const greetingInput = this.elements.greetingInput;
                const greetingLabel = this.elements.greetingLabel;
                const modalTitle = this.elements.modalTitle;
                const openMapButton = this.elements.openMapButton;
                const deleteGreetingButton = this.elements.deleteGreetingButton;

                modalContent.classList.toggle('add-new-name', isAddingNewName);
                modalTitle.textContent = isAddingNewName ? 'Добавить новое имя' :
                    isEditingStartPoint ? 'Редактировать координаты начальной точки' :
                        isMachine ? 'Редактировать координаты машины' : 'Редактировать координаты';

                [nameLabel, nameInput, greetingLabel, greetingInput, deleteGreetingButton].forEach(el => el.style.display = 'none');
                [coordsLabel, coordsHelp, coordsInput, openMapButton].forEach(el => el.style.display = 'block');
// выбор станций

const stSel = document.getElementById('stationSelect');
if (isMachine) {
  stSel.style.display = 'block';
  stSel.innerHTML = '<option value="">– Выбрать из списка –</option>' +
    Object.entries(this.stations)
      .map(([name,c]) => `<option value="${c.lat},${c.lng}">${name}</option>`)
      .join('');

  /* ➜ подсветить ранее сохранённую станцию */
  const saved = this.machineStop.lat && this.machineStop.lng ? `${this.machineStop.lat},${this.machineStop.lng}` : '';
  stSel.value = saved && [...stSel.options].some(o => o.value === saved) ? saved : '';

  stSel.onchange = () => {
    this.elements.coordsInput.value = stSel.value;
  };
} else {
  stSel.style.display = 'none';
}



                if (isAddingNewName) {
                    nameLabel.style.display = 'block';
                    nameInput.style.display = 'block';
                    nameInput.value = '';
                    coordsInput.value = '';
                } else if (isEditingStartPoint) {
                    coordsInput.value = this.startPointCoords.lat && this.startPointCoords.lng ? `${this.startPointCoords.lat},${this.startPointCoords.lng}` : '';
                } else if (isMachine) {
                    coordsInput.value = this.machineStop.lat && this.machineStop.lng ? `${this.machineStop.lat},${this.machineStop.lng}` : '';
                } else {
                    const participant = this.participants[index];
                    coordsInput.value = participant.lat && participant.lng ? `${participant.lat},${participant.lng}` : '';
                }
                modal.style.display = 'flex';
                (isAddingNewName ? nameInput : coordsInput).focus();
            }

            openGreetingModal(isAddingNewGreeting) {
                this.isAddingNewGreeting = isAddingNewGreeting;
                this.isEditingGreeting = !isAddingNewGreeting;
                this.isAddingNewName = false;
                this.isEditingMachine = false;
                this.isEditingStartPoint = false;
                const modal = this.elements.coordsModal;
                const modalContent = this.elements.modalContent;
                modalContent.classList.remove('add-new-name');
                this.elements.modalTitle.textContent = isAddingNewGreeting ? 'Добавить новое приветствие' : 'Редактировать приветствие';
                ['coordsLabel', 'coordsHelp', 'coordsInput', 'openMapButton', 'nameLabel', 'nameInput'].forEach(el => this.elements[el].style.display = 'none');
                this.elements.greetingLabel.style.display = 'block';
                this.elements.greetingInput.style.display = 'block';
                this.elements.greetingInput.value = this.greeting;
                this.elements.deleteGreetingButton.style.display = this.defaultGreetings.includes(this.greeting) ? 'none' : 'inline-block';
                modal.style.display = 'flex';
                this.elements.greetingInput.focus();
            }

            async saveCoordinates() {
                const saveButton = this.elements.saveCoordsButton;
                const original = saveButton.textContent;
                saveButton.textContent = 'Загрузка...';
                saveButton.disabled = true;
                try {
                    if (this.isAddingNewGreeting || this.isEditingGreeting) {
                        const newGreeting = this.elements.greetingInput.value.trim();
                        if (!newGreeting) { this.showToast("Введите приветствие."); return; }
                        if (this.isAddingNewGreeting && this.greetings.includes(newGreeting)) { this.showToast("Приветствие уже существует."); return; }
                        if (this.isEditingGreeting) {
                            const old = this.greeting;
                            const idx = this.greetings.indexOf(old);
                            if (idx !== -1 && !this.defaultGreetings.includes(old)) this.greetings[idx] = newGreeting;
                            this.greeting = newGreeting;
                        } else if (this.isAddingNewGreeting) {
                            this.greetings.push(newGreeting);
                            this.greeting = newGreeting;
                        }
                        this.closeModal(); this.saveData(); this.renderParticipants(); this.calculate();
                    } else {
                        const raw = this.elements.coordsInput.value.trim();
let coords = null;
if (raw) {                                  // пользователь что-то ввёл
  coords = await this.parseCoordinates(raw);
  if (!coords) return;                    // только требуем корректность
}
// если raw пуст – coords остаётся null, продолжаем сохранять
                        if (this.isAddingNewName) {
    const name = this.elements.nameInput.value.trim();
    if (!name) { this.showToast("Введите имя."); return; }
    if (this.nameToCoordinates[name]) { this.showToast("Имя уже существует."); return; }

    /* 1. СОХРАНЯЕМ имя (с координатами или без) */
    this.nameToCoordinates[name] = coords
        ? { lat: coords.lat, lng: coords.lng }
        : { lat: null, lng: null };

    /* 2. ОБНОВЛЯЕМ участника / старт-поинт, используя СВОЙСТВО ОБЪЕКТА,
          а не переменную coords (которая может быть null) */
    if (this.isEditingStartPoint) {
        this.startPoint = name;
        this.startPointCoords = { ...this.nameToCoordinates[name] }; // безопасно
        this.participants = [];
    } else {
        const p = this.participants[this.currentEditIndex];
        p.name = name;
        p.lat  = this.nameToCoordinates[name].lat;
        p.lng  = this.nameToCoordinates[name].lng;
        p.timeManuallyEdited = false;
    }
    this.updateParticipantTimes();
}

                        
                        else if (this.isEditingMachine) {
                            this.machineStop.lat = coords.lat; this.machineStop.lng = coords.lng;
                        } else if (this.isEditingStartPoint) {
                            this.startPointCoords = { lat: coords.lat, lng: coords.lng };
                            this.updateParticipantTimes();
                        } else {
                            this.participants[this.currentEditIndex].lat = coords.lat;
                            this.participants[this.currentEditIndex].lng = coords.lng;
                            this.participants[this.currentEditIndex].timeManuallyEdited = false;
                            this.updateParticipantTimes();
                        }
                        this.closeModal(); this.saveData(); this.renderParticipants(); this.initSortable(); this.calculate();
                    }
                } finally {
                    saveButton.textContent = original;
                    saveButton.disabled = false;
                }
            }

            deleteGreeting() {
                if (!this.defaultGreetings.includes(this.greeting)) {
                    this.greetings = this.greetings.filter(g => g !== this.greeting);
                    this.greeting = this.defaultGreetings[0];
                    this.closeModal(); this.saveData(); this.renderParticipants(); this.calculate();
                }
            }

            closeModal() {
                this.elements.coordsModal.style.display = 'none';
                this.isAddingNewName = this.isEditingMachine = this.isAddingNewGreeting = this.isEditingGreeting = this.isEditingStartPoint = false;
                this.currentEditIndex = null;
            }

            openMapForSelection() {
                const coords = this.elements.coordsInput.value.trim();
                let url = 'https://www.google.com/maps';
                if (coords) {
                    const parsed = this.parseCoords(coords);
                    if (parsed) url += `/place/${parsed.lat},${parsed.lng}`;
                    else url += `/search/${encodeURIComponent(coords)}`;
                }
                window.open(url, '_blank');
            }

            addParticipant() {
                this.participants.push({ name: '', time: 5, lat: null, lng: null, timeManuallyEdited: false });
                this.updateParticipantTimes();
                this.saveData();
                this.renderParticipants();
                this.initSortable();
                this.calculate();
            }

            updateName(index, value) {
                if (value === 'add-new') this.openCoordsModal(index, false, true);
                else {
                    this.participants[index].name = value;
                    const coords = this.nameToCoordinates[value] || { lat: null, lng: null };
                    this.participants[index].lat = coords.lat;
                    this.participants[index].lng = coords.lng;
                    this.participants[index].timeManuallyEdited = false;
                    this.updateParticipantTimes();
                    this.saveData();
                    this.renderParticipants();
                    this.initSortable();
                    this.calculate();
                }
            }

            updateTime(index, value) {
                const time = parseInt(value) || 5;
                this.participants[index].time = Math.max(1, Math.min(120, time));
                this.participants[index].timeManuallyEdited = true;
                this.saveData();
                this.renderParticipants();
                this.calculate();
            }

            updateMachineName(value) {
                this.machineStop.name = value.trim() || 'an der Maschine';
                this.saveData();
                this.calculate();
            }

            updateMachineTime(value) {
                const time = parseInt(value) || 20;
                this.machineStop.time = Math.max(1, Math.min(720, time));
                this.saveData();
                this.calculate();
            }

            clearArrivalTime() {
                this.machineStop.arrivalTime = "";
                this.saveData();
                this.elements.output.innerHTML = '';
                this.renderParticipants();
            }

            startTimeEdit() {
                const container = document.querySelector('.machine .right-section');
                const existingInput = container.querySelector('input[type="time"]');
                if (existingInput) existingInput.remove();

                const input = document.createElement('input');
                input.type = 'time';
                input.style.width = '100px';
                input.style.padding = 'var(--small-spacing)';
                input.style.border = '1px solid #ddd';
                input.style.borderRadius = '4px';
                input.style.fontSize = '1em';
                input.value = this.machineStop.arrivalTime || '';
                const timeControl = container.querySelector('.time-icon') || container.querySelector('.arrival-time');
                container.insertBefore(input, timeControl);
                timeControl.style.display = 'none';

                const saveTime = () => {
                    this.machineStop.arrivalTime = input.value;
                    container.removeChild(input);
                    timeControl.style.display = 'flex';
                    this.renderParticipants();
                    this.initSortable();
                    this.calculate();
                    input.removeEventListener('change', saveTime);
                    input.removeEventListener('blur', saveTime);
                };
                input.addEventListener('change', saveTime);
                input.addEventListener('blur', () => setTimeout(saveTime, 50));
                input.focus();
                try { input.showPicker(); } catch { }
            }

            initSortable() {
                if (this.sortable) this.sortable.destroy();
                this.sortable = new Sortable(this.elements.participantsContainer, {
                    handle: '.material-symbols-outlined',
                    animation: 150,
                    onEnd: evt => {
                        if (evt.oldIndex !== evt.newIndex) {
                            const [moved] = this.participants.splice(evt.oldIndex, 1);
                            this.participants.splice(evt.newIndex, 0, moved);
                            this.updateParticipantTimes();
                            this.saveData();
                            this.renderParticipants();
                            this.calculate();
                        }
                    }
                });
            }

            showToast(message) {
                this.elements.toast.textContent = message;
                this.elements.toast.classList.add('show');
                setTimeout(() => this.elements.toast.classList.remove('show'), 3000);
            }

            formatTime(date) {
                if (this.useSuperscriptTime) {
                    const hours = date.getHours().toString().padStart(2, '0');
                    const minutes = date.getMinutes().toString().padStart(2, '0');
                    const superscriptDigits = ['⁰', '¹', '²', '³', '⁴', '⁵', '⁶', '⁷', '⁸', '⁹'];
                    const superscriptMinutes = minutes.split('').map(d => superscriptDigits[parseInt(d)]).join('');
                    return `${hours}${superscriptMinutes}`;
                }
                return date.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
            }

            calculate(){
  if(!this.machineStop.arrivalTime){this.elements.output.innerHTML='';return}
  let out=`${this.greeting},\n`;

  const valid=this.participants.filter(p=>p.name);
  const total=valid.reduce((s,p)=>s+p.time,0)+this.machineStop.time;

  // 1. ВЫЧИСЛЯЕМ ВРЕМЯ СТАРТА
  const startTime=new Date(`2025-07-25T${this.machineStop.arrivalTime}:00`);
  startTime.setMinutes(startTime.getMinutes()-total);

  // 2. ФОРМИРУЕМ ВЫВОД
  out+=this.useUhrBei
    ? `um ${this.formatTime(startTime)} Uhr geht's los\n`
    : `${this.formatTime(startTime)}  geht's los\n`;

  let current=new Date(startTime);
  valid.forEach(p=>{
    current.setMinutes(current.getMinutes()+p.time);
    out+=this.useUhrBei
      ? `um ${this.formatTime(current)} Uhr bei ${p.name}\n`
      : `${this.formatTime(current)}  ${p.name}\n`;
  });

  // Время прибытия к машине
  const machineTime=new Date(`2025-07-25T${this.machineStop.arrivalTime}:00`);
  out+=this.useUhrBei
    ? `um ${this.formatTime(machineTime)} Uhr ${this.machineStop.name}\n`
    : `${this.formatTime(machineTime)}  ${this.machineStop.name}\n`;

  this.elements.output.innerHTML=out;
}


            openGoogleMaps(returnTrip = false) {
                const validParticipants = this.participants.filter(p => p.name && p.lat && p.lng);
                if (!this.startPointCoords.lat || !this.startPointCoords.lng || validParticipants.length === 0) {
                    this.showToast("Добавьте начальную точку и хотя бы одного участника с координатами.");
                    return;
                }
                let url = 'https://www.google.com/maps/dir/';
                if (!returnTrip) {
                    url += `${this.startPointCoords.lat},${this.startPointCoords.lng}/`;
                    validParticipants.forEach(p => url += `${p.lat},${p.lng}/`);
                    if (this.machineStop.lat && this.machineStop.lng) url += `${this.machineStop.lat},${this.machineStop.lng}`;
                } else {
                    if (this.machineStop.lat && this.machineStop.lng) url += `${this.machineStop.lat},${this.machineStop.lng}/`;
                    for (let i = validParticipants.length - 1; i >= 0; i--) url += `${validParticipants[i].lat},${validParticipants[i].lng}/`;
                    url += `${this.startPointCoords.lat},${this.startPointCoords.lng}`;
                }
                window.open(url, '_blank');
            }

            copyResult() {
                const text = this.elements.output.textContent.trim();
                if (!text) {
                    this.showToast("Нечего копировать — сначала рассчитайте маршрут.");
                    return;
                }
                navigator.clipboard.writeText(text)
                    .then(() => this.showToast("Результат скопирован в буфер обмена!"))
                    .catch(() => this.showToast("Не удалось скопировать — разрешите доступ к буферу обмена."));
            }

            removeParticipant(index) {
                this.participants.splice(index, 1);
                this.updateParticipantTimes();
                this.saveData();
                this.renderParticipants();
                this.initSortable();
                this.calculate();
            }
        }
document.addEventListener('DOMContentLoaded', () => {
  new FahrzeitRechner();

  // ---------- тема ----------
  const switcher = document.getElementById('themeSwitch');
  if (!switcher) return;

  // УСТАНАВЛИВАЕМ ЦВЕТ СТАТУС-БАРА СРАЗУ
  const meta = document.getElementById('theme-meta');
  meta.content = (localStorage.theme === 'dark') ? '#121212' : '#f0f0f0';

  // восстанавливаем сохранённую тему
  if (localStorage.theme === 'dark') document.body.classList.add('dark');
  switcher.checked = localStorage.theme === 'dark';

  // переключаем по клику
  switcher.addEventListener('change', e => {
    document.body.classList.toggle('dark', e.target.checked);
    localStorage.theme = e.target.checked ? 'dark' : 'light';
    meta.content = e.target.checked ? '#121212' : '#f0f0f0';
  });
});

    </script>
    
<!-- подключаем bcrypt ДО нашего кода -->
<script src="https://cdn.jsdelivr.net/npm/bcryptjs@2.4.3/dist/bcrypt.min.js"></script>

<script>
/* хэш пароля '1234' (10 раундов) */
const GOD_HASH = '$2a$10$6L8o8LHHMfsH.CoKfGjkfO7k1.PpfgTZZtFNNXf3z1yLQ0yh5K0Oi';

document.addEventListener('DOMContentLoaded', () => {
  const link = document.getElementById('godL');   // у вас id="godL"
  if (!link) return;

  link.addEventListener('click', async (e) => {
    e.preventDefault();
    const pwd = prompt('Введите пароль:');
    if (!pwd) return;
    const ok = await bcrypt.compare(pwd, GOD_HASH);
    if (ok) location.href = link.href;
    else alert('Неверный пароль');
  });
});
</script>


</body>

</html>
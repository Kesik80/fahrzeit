<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Fahrzeit Rechner</title>
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&icon_names=swap_vert" />
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.6/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/latlon-geohash@2.0.0/latlon-geohash.min.js"></script>
    <style>
        :root {
            --primary-color: #007bff;
            --success-color: #28a745;
            --info-color: #6c757d;
            --danger-color: #dc3545;
            --background-color: #f0f0f0;
            --surface-color: white;
            --text-color: #333;
            --border-radius: 6px;
            --spacing-unit: 10px;
            --small-spacing: 6px;
            --button-size: 44px;
            --button-font-size: 0.9em;
        }

        body {
            font-family: sans-serif;
            padding: 10px;
            max-width: 500px;
            margin: auto;
            background: var(--background-color);
            color: var(--text-color)
        }

        h2 {
            text-align: center
        }

        button {
            padding: var(--spacing-unit);
            margin-top: var(--spacing-unit);
            width: 100%;
            border: none;
            border-radius: var(--border-radius);
            color: white;
            cursor: pointer;
            font-size: var(--button-font-size);
            transition: background-color .2s ease, transform .1s ease;
            height: var(--button-size);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px
        }

        button:hover {
            opacity: .9;
            transform: translateY(-1px)
        }

        .calculate {
            background: var(--primary-color)
        }

        .copy {
            background: var(--success-color)
        }

        .add {
            background: var(--info-color)
        }

        .clear {
            background: var(--danger-color)
        }

        .route-back {
            background: #6f42c1
        }

        .greeting-container {
            background: var(--surface-color);
            border-radius: var(--border-radius);
            padding: var(--spacing-unit);
            margin-bottom: var(--spacing-unit);
            box-shadow: 0 1px 3px rgba(0, 0, 0, .1);
            display: flex;
            align-items: center;
            gap: var(--spacing-unit);
            flex-wrap: wrap
        }

        .greeting-container select {
            width: 35%;
            padding: var(--small-spacing);
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1em;
            box-sizing: border-box
        }

        .greeting-container .edit-greeting-btn,
        .greeting-container .start-point-coords {
            width: 24px;
            height: 24px;
            background: transparent;
            border: none;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            flex-shrink: 0;
            line-height: 1;
            padding: 0
        }

        .participant {
            background: var(--surface-color);
            border-radius: var(--border-radius);
            padding: var(--spacing-unit);
            margin-bottom: var(--spacing-unit);
            display: flex;
            align-items: center;
            gap: var(--spacing-unit);
            flex-wrap: wrap;
            box-shadow: 0 1px 3px rgba(0, 0, 0, .1)
        }

        .participant select,
        .participant input[type=text] {
            flex: 1;
            min-width: 35%;
            max-width: 35%;
            padding: var(--small-spacing);
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1em;
            box-sizing: border-box
        }

        .participant input[type=number] {
            width: 50px;
            padding: var(--small-spacing);
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1em;
            text-align: center
        }

        .participant .right-section {
            margin-left: auto;
            display: flex;
            gap: var(--small-spacing);
            align-items: center;
            justify-content: flex-end;
            min-height: 32px;
        }

        .participant .remove-btn {
            width: 20px;
            height: 20px;
            background: var(--danger-color);
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            flex-shrink: 0;
            line-height: 1;
            padding: 0;
            transform: translate(5px, -15px);

        }


        .time-remove {
            width: 24px;
            height: 24px;
            background: transparent;
            color: var(--danger-color);
            border: none;
            border-radius: 4px;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            flex-shrink: 0;
            line-height: 1;
            transform: translateY(-5px);
            margin-top: -5px;
            margin-right: -7px;
        }

        .arrival-time {
            font-weight: bold;
            cursor: pointer;
            font-size: 1em;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: var(--small-spacing);
            background: #e9e9e9;
            border-radius: 4px;
            line-height: 1;
        }

        .time-icon,
        .coords-icon,
        .start-point-coords {
            font-size: 24px;
            width: 24px;
            height: 24px;
            border: none;
            background: transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            line-height: 1;
            padding: 0;
            transform: translateY(-5px)
        }

        .coords-icon svg {
            width: 100%;
            height: 100%
        }

        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
            font-size: 24px;
            color: var(--info-color);
            transform: translate(-15px, 0);
            cursor: grab
        }

        input,
        select {
            font-size: 1em
        }

        pre {
            background: var(--surface-color);
            padding: var(--spacing-unit);
            border-radius: var(--border-radius);
            white-space: pre-wrap;
            font-size: 1.1em;
            margin-top: 15px;
            min-height: 50px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, .1)
        }

        .toast {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--danger-color);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1.2em;
            display: none;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0, 0, 0, .2);
            text-align: center
        }

        .sortable-ghost {
            opacity: .2;
            background: #c8ebfb
        }

        .button-container {
            display: flex;
            flex-direction: row;
            gap: 6px;
            margin-top: var(--spacing-unit);
            flex-wrap: nowrap
        }

        .button-container button {
            flex: 1;
            margin-top: 0;
            padding: var(--small-spacing) 8px;
            font-size: .8em;
            min-width: 60px
        }

        .button-container .add {
            grid-column: span 2
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, .5);
            z-index: 1000;
            justify-content: center;
            align-items: center
        }

        .modal-content {
            background: var(--surface-color);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: 0 2px 8px rgba(0, 0, 0, .2);
            max-width: 300px;
            width: 100%;
            text-align: center;
            transition: transform .2s ease
        }

        .modal-content.add-new-name {
            background: linear-gradient(135deg, #f0f8ff 0%, #e6f0fa 100%);
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, .3);
            transform: scale(1.02)
        }

        .modal-content.add-new-name h3 {
            font-size: 1.4em;
            color: #1a3c6d;
            margin-bottom: 15px
        }

        .modal-content.add-new-name label {
            font-size: 1.1em;
            color: #1a3c6d;
            font-weight: 500
        }

        .modal-content input[type=text] {
            width: 100%;
            padding: 8px;
            margin: 8px 0;
            border: 1px solid #b0c4de;
            border-radius: 4px;
            font-size: 1em;
            box-sizing: border-box
        }

        .modal-buttons {
            display: flex;
            flex-direction: row;
            gap: var(--spacing-unit);
            justify-content: center;
            margin-top: var(--spacing-unit)
        }

        .modal-content button {
            flex: 1;
            max-width: 120px;
            padding: 10px;
            margin: 0;
            border-radius: 4px;
            font-size: 1em;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color .2s ease, transform .1s ease
        }

        .modal-content button:hover {
            transform: translateY(-1px)
        }

        .modal-content .save-button {
            background: var(--success-color)
        }

        .modal-content .cancel-button {
            background: var(--info-color)
        }

        .modal-content .delete-greeting-btn {
            background: var(--danger-color)
        }

        .modal-content .map-button {
            display: block;
            margin-left: auto;
            margin-right: auto;
            margin-top: var(--spacing-unit);
            margin-bottom: var(--spacing-unit);
            background: var(--primary-color);
        }

        #result {
            font-family: Arial, sans-serif;
            font-size: 16px;
            line-height: 1.5;
            margin: 10px 0;
            white-space: pre-wrap
        }

        #result sup {
            font-size: .7em;
            vertical-align: super
        }

        .checkbox-container {
            display: flex;
            gap: var(--small-spacing);
            margin-top: var(--spacing-unit);
            justify-content: flex-end;
        }
    </style>
</head>

<body>
    <main>
        <h2>Fahrzeit Rechner</h2>
        <div class="greeting-container">
            <select id="startPoint" aria-label="Выберите начальную точку">
                <option value="" disabled>Выберите начальную точку</option>
            </select>
            <button class="start-point-coords" title="Редактировать координаты начальной точки"></button>
            <select id="greeting" aria-label="Выберите приветствие">
                <option value="Moin zusammen" selected>Moin zusammen</option>
                <option value="Hallo zusammen">Hallo zusammen</option>
                <option value="Guten Morgen">Guten Morgen</option>
                <option value="Guten Tag">Guten Tag</option>
                <option value="add-new-greeting">Добавить новое приветствие</option>
            </select>
            <button class="edit-greeting-btn" title="Редактировать или удалить приветствие">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" width="18" height="18">
                    <path
                        d="M46.193 6.863a7.48 7.48 0 0 0-4.717 2.13L15.434 38.771S15.213 39.215 13.725 46.12c-.28-.074-.44-.204-.74-.267a1 1 0 0 0-.41 1.957c.305.064.452.186.73.262L11.799 55.045a1 1 0 0 0 1.38 1.125L20.553 52.9a1 1 0 0 0 .552-1.21s-.398-1.223-1.601-2.494c-.81-.855-2.192-1.688-3.883-2.404L17.113 39.9c.259-.3 20.274-23.473 25.815-29.52C47.764 5.267 55.893 14.152 52.834 17.424l-.022.023S33.986 38.92 27.871 46.266c-.79-1.355-1.806-2.557-2.826-3.433-.864-.742-1.162-.886-1.641-1.201L45.92 16.09a1 1 0 0 0-1.5-1.323L21.186 41.125a1 1 0 0 0 .24 1.521s1.084.645 2.316 1.703c1.232 1.058 2.549 2.529 3.022 3.945a1 1 0 0 0 1.722.317C33.662 42.3 54.262 18.827 54.295 18.79c3.881-4.151-1.668-11.392-7.387-11.9a7.55 7.55 0 0 0-1.715-.027zM15.203 48.752l1.035-4.795-4.527 1.998 4.492 2.797z"
                        stroke="#000" stroke-width="2" fill="none" />
                </svg>
            </button>
        </div>

        <div id="participants"></div>

        <div class="button-container">
            <button class="add" title="Teilnehmer hinzufügen">
                <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 -960 960 960" width="24" fill="#e3e3e3">
                    <path
                        d="M480-80Q319-217 239.5-334.5T160-552q0-150 96.5-239T480-880h20q10 0 20 2v81q-10-2-19.5-2.5T480-800q-101 0-170.5 69.5T240-552q0 71 59 162.5T480-186q122-112 181-203.5T720-552v-8h80v8q0 100-79.5 217.5T480-80Zm0-400q33 0 56.5-23.5T560-560q0-33-23.5-56.5T480-640q-33 0-56.5 23.5T400-560q0 33 23.5 56.5T480-480Zm0-80Zm240-80h80v-120h120v-80H800v-120h-80v120H600v80h120v120Z" />
                </svg>
            </button>
            <button class="calculate" title="Berechnen">
                <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 -960 960 960" width="24" fill="#e3e3e3">
                    <path
                        d="m226-559 78 33q14-28 29-54t33-52l-56-11-84 84Zm142 83 114 113q42-16 90-49t90-75q70-70 109.5-155.5T806-800q-72-5-158 34.5T492-656q-42 42-75 90t-49 90Zm178-65q-23-23-23-56.5t23-56.5q23-23 57-23t57 23q23 23 23 56.5T660-541q-23 23-57 23t-57-23Zm19 321 84-84-11-56q-26 18-52 32.5T532-299l33 79Zm313-653q19 121-23.5 235.5T708-419l20 99q4 20-2 39t-20 33L538-80l-84-197-171-171-197-84 167-168q14-14 33.5-20t39.5-2l99 20q104-104 218-147t235-24ZM157-321q35-35 85.5-35.5T328-322q35 35 34.5 85.5T327-151q-25 25-83.5 43T82-76q14-103 32-161.5t43-83.5Zm57 56q-10 10-20 36.5T180-175q27-4 53.5-13.5T270-208q12-12 13-29t-11-29q-12-12-29-11.5T214-265Z" />
                </svg>
            </button>
            <button class="route-back" title="Маршрут назад">
                <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1"
                    width="24px" height="24px" viewBox="0 0 256 256" xml:space="preserve">
                    <g style="stroke: none; stroke-width: 0; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: none; fill-rule: nonzero; opacity: 1;"
                        transform="translate(1.4065934065934016 1.4065934065934016) scale(2.81 2.81)">
                        <path
                            d="M 77.612 90 H 12.388 c -0.829 0 -1.5 -0.672 -1.5 -1.5 V 36.637 H 1.5 c -0.642 0 -1.212 -0.408 -1.419 -1.015 c -0.208 -0.607 -0.006 -1.279 0.502 -1.671 l 43.5 -33.637 c 0.54 -0.418 1.295 -0.418 1.835 0 l 43.5 33.637 c 0.507 0.393 0.709 1.064 0.502 1.671 c -0.208 0.607 -0.778 1.015 -1.42 1.015 h -9.388 V 88.5 C 79.112 89.328 78.44 90 77.612 90 z M 13.888 87 h 62.225 V 35.137 c 0 -0.829 0.672 -1.5 1.5 -1.5 h 6.496 L 45 3.396 L 5.892 33.637 h 6.496 c 0.829 0 1.5 0.671 1.5 1.5 V 87 z"
                            style="stroke: #e3e3e3; stroke-width: 3; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: #e3e3e3; fill-rule: nonzero; opacity: 1;"
                            transform="matrix(1 0 0 1 0 0)" stroke-linecap="round" />
                        <path
                            d="M 45 81.51 L 30.514 64.449 C 27.603 61.019 26 56.657 26 52.169 c 0 -10.477 8.523 -19 19 -19 s 19 8.523 19 19 c 0 4.489 -1.603 8.851 -4.514 12.28 L 45 81.51 z M 45 36.169 c -8.822 0 -16 7.177 -16 16 c 0 3.778 1.35 7.45 3.801 10.339 L 45 76.875 l 12.199 -14.367 C 59.65 59.619 61 55.948 61 52.169 C 61 43.347 53.822 36.169 45 36.169 z M 45 60.264 c -4.795 0 -8.697 -3.901 -8.697 -8.696 c 0 -4.796 3.901 -8.697 8.697 -8.697 c 4.796 0 8.697 3.901 8.697 8.697 C 53.697 56.362 49.796 60.264 45 60.264 z M 45 45.87 c -3.141 0 -5.697 2.556 -5.697 5.697 c 0 3.141 2.556 5.696 5.697 5.696 c 3.142 0 5.697 -2.556 5.697 -5.696 C 50.697 48.426 48.142 45.87 45 45.87 z"
                            style="stroke: #e3e3e3; stroke-width: 3; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: #e3e3e3; fill-rule: nonzero; opacity: 1;"
                            transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round" />
                    </g>
                </svg>
            </button>
          <button class="copy" title="Kopieren" aria-label="Kopieren">

                <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 -960 960 960" width="24" fill="#e3e3e3">
                    <path
                        d="M360-240q-33 0-56.5-23.5T280-320v-480q0-33 23.5-56.5T360-880h360q33 0 56.5 23.5T800-800v480q0 33-23.5 56.5T720-240H360Zm0-80h360v-480H360v480ZM200-80q-33 0-56.5-23.5T120-160v-560h80v560h440v80H200Zm160-240v-480 480Z" />
                </svg>
            </button>
            <button class="clear" title="Сбросить данные">
                <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1"
                    width="24px" height="24px" viewBox="0 0 256 256" xml:space="preserve">
                    <g style="stroke: none; stroke-width: 0; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: none; fill-rule: nonzero; opacity: 1;"
                        transform="translate(1.4065934065934016 1.4065934065934016) scale(2.81 2.81)">
                        <path
                            d="M 7.288 48.34 c 0.061 0.04 0.129 0.068 0.193 0.105 c 0.18 0.105 0.363 0.201 0.559 0.277 c 0.093 0.036 0.19 0.06 0.286 0.089 c 0.175 0.053 0.351 0.098 0.535 0.127 c 0.049 0.008 0.094 0.028 0.144 0.034 C 9.164 48.99 9.322 49 9.481 49 c 0 0 0 0 0.001 0 c 0 0 0 0 0 0 c 0 0 0 0 0 0 c 0.267 0 0.531 -0.028 0.79 -0.08 c 0.154 -0.031 0.297 -0.086 0.443 -0.134 c 0.101 -0.033 0.206 -0.054 0.304 -0.094 c 0.162 -0.067 0.31 -0.158 0.46 -0.245 c 0.075 -0.043 0.156 -0.075 0.228 -0.124 c 0.217 -0.146 0.42 -0.311 0.604 -0.495 c 0 0 0 0 0 0 l 7.492 -7.492 c 1.562 -1.562 1.562 -4.095 0 -5.657 c -1.149 -1.149 -2.822 -1.445 -4.249 -0.903 c 4.535 -11.868 16.033 -20.322 29.475 -20.322 c 12.266 0 23.516 7.2 28.658 18.342 c 0.926 2.004 3.3 2.881 5.309 1.956 c 2.005 -0.926 2.881 -3.302 1.955 -5.308 C 74.503 14.478 60.403 5.455 45.027 5.455 c -17.837 0 -32.947 11.873 -37.859 28.129 c -1.224 -1.611 -3.48 -2.084 -5.247 -1.008 c -1.887 1.148 -2.486 3.609 -1.338 5.496 l 5.481 9.007 c 0.014 0.023 0.035 0.041 0.049 0.063 c 0.125 0.195 0.268 0.375 0.424 0.545 c 0.036 0.039 0.064 0.085 0.101 0.122 C 6.835 48.009 7.053 48.186 7.288 48.34 z"
                            style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill:#e3e3e3; fill-rule: nonzero; opacity: 1;"
                            transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round" />
                        <path
                            d="M 89.416 51.929 l -5.48 -9.008 c -0.014 -0.023 -0.035 -0.04 -0.049 -0.063 c -0.125 -0.195 -0.268 -0.375 -0.424 -0.546 c -0.035 -0.039 -0.063 -0.084 -0.1 -0.121 c -0.197 -0.199 -0.415 -0.376 -0.65 -0.531 c -0.061 -0.04 -0.129 -0.067 -0.192 -0.104 c -0.18 -0.105 -0.364 -0.201 -0.56 -0.277 c -0.093 -0.036 -0.19 -0.06 -0.287 -0.089 c -0.174 -0.053 -0.35 -0.098 -0.534 -0.127 c -0.049 -0.008 -0.095 -0.028 -0.144 -0.034 c -0.07 -0.008 -0.138 0.003 -0.208 -0.001 C 80.697 41.021 80.611 41 80.519 41 c -0.082 0 -0.159 0.019 -0.239 0.024 c -0.121 0.007 -0.24 0.018 -0.36 0.036 c -0.172 0.026 -0.338 0.065 -0.503 0.113 c -0.105 0.03 -0.209 0.058 -0.312 0.097 c -0.178 0.067 -0.344 0.152 -0.509 0.243 c -0.082 0.045 -0.166 0.082 -0.245 0.133 c -0.237 0.153 -0.46 0.326 -0.659 0.524 c 0 0 -0.001 0.001 -0.001 0.001 l 0 0 l 0 0 l -7.492 7.492 c -1.562 1.562 -1.562 4.095 0 5.656 c 1.148 1.15 2.822 1.446 4.249 0.904 c -4.535 11.868 -16.033 20.321 -29.475 20.321 c -12.707 0 -24.117 -7.563 -29.068 -19.268 c -0.861 -2.034 -3.209 -2.988 -5.242 -2.125 c -2.035 0.86 -2.986 3.207 -2.126 5.242 c 6.206 14.671 20.508 24.151 36.436 24.151 c 17.831 0 32.937 -11.864 37.854 -28.111 c 0.774 1.015 1.96 1.574 3.176 1.574 c 0.708 0 1.426 -0.188 2.075 -0.584 C 89.966 56.276 90.565 53.816 89.416 51.929 z"
                            style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill:#e3e3e3; fill-rule: nonzero; opacity: 1;"
                            transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round" />
                    </g>
                </svg>
            </button>
        </div>



        <pre id="output"></pre>
        <div id="toast" class="toast"></div>

        <div id="coordsModal" class="modal">
            <div class="modal-content">
                <h3 id="modalTitle">Редактировать координаты</h3>
                <label id="nameLabel" style="display:none">Имя:</label>
                <input type="text" id="nameInput" style="display:none" placeholder="Введите имя" />
                <label id="greetingLabel" style="display:none">Приветствие:</label>
                <input type="text" id="greetingInput" style="display:none" placeholder="Введите приветствие" />
                <label id="coordsLabel" style="display:none">Введите координаты<br>(широта,долгота или URL Google
                    Карт):</label>
                <input type="text" id="coordsInput" style="display:none"
                    placeholder="51.452013,7.021455 или https://maps.app.goo.gl/..." />
                <p id="coordsHelp" style="display:none;color:#d32f2f;font-weight:bold">Сокращённые ссылки обрабатываются
                    несколько секунд.</p>
                <button class="map-button" id="openMap" style="display:none">
                    <svg width="24" height="24" viewBox="0 0 90 90" fill="currentColor">
                        <path
                            d="M89 79.382H1c-.355 0-.683-.188-.863-.494-.179-.306-.183-.685-.01-.994L15.174 49.373c.177-.315.511-.512.873-.512h22.326c.552 0 1 .447 1 1s-.448 1-1 1H17.534L2.705 77.382h84.59L72.466 50.86H50.728c-.553 0-1-.447-1-1s.447-1 1-1h22.325c.362 0 .696.196.873.512l15.947 28.521c.173.31.169.688-.011.994s-.778.484-1.132.484z" />
                        <path
                            d="M45 60.554L30.514 43.493C27.603 40.063 26 35.701 26 31.213c0-10.477 8.523-19 19-19s19 8.523 19 19c0 4.489-1.603 8.851-4.514 12.28L45 60.554zM45 15.713c-8.28 0-15.016 6.736-15.016 15.016 0 3.778 1.35 7.45 3.801 10.339L45 45.875l12.199-14.367C59.65 38.619 61 34.948 61 31.169c0-8.822-7.177-16-16-16z" />
                        <path
                            d="M45.024 35.998c-4.769 0-8.649-3.88-8.649-8.649s3.88-8.649 8.649-8.649 8.649 3.88 8.649 8.649-3.88 8.649-8.649 8.649zm0-15.298c-3.666 0-6.649 2.983-6.649 6.649s2.983 6.649 6.649 6.649 6.649-2.983 6.649-6.649-2.983-6.649-6.649-6.649z" />
                        <path
                            d="M1 79.382c-.441 0-.845-.294-.965-.74-.143-.533.173-1.082.706-1.226l76.501-20.565c.531-.145 1.082.172 1.226.706.144.533-.173 1.082-.706 1.226L1.26 79.348c-.087.023-.175.034-.26.034z" />
                        <path
                            d="M63.521 73.279c-.286 0-.569-.121-.767-.357l-7.332-8.733c-.355-.423-.301-1.054.123-1.408.423-.355 1.056-.301 1.408.123l7.332 8.733c.355.423.301 1.054-.123 1.408-.247.202-.476.279-.703.279z" />
                        <path
                            d="M34.419 70.398c-.285 0-.568-.121-.766-.357L23.606 58.075c-.355-.423-.3-1.054.123-1.408.424-.354 1.054-.301 1.409.123l10.047 11.966c.355.423.3 1.054-.123 1.408-.247.202-.476.279-.703.279z" />
                    </svg>
                </button>
                <div class="modal-buttons">
                    <button class="save-button" id="saveCoords">Сохранить</button>
                    <button class="cancel-button" id="cancelCoords">Отмена</button>
                    <button class="delete-greeting-btn" id="deleteGreeting" style="display:none">Удалить</button>
                </div>
            </div>
        </div>
    </main>

    <script>
        "use strict";
        class FahrzeitRechner {
            constructor() {
                this.defaultGreetings = ['Moin zusammen', 'Hallo zusammen', 'Guten Morgen', 'Guten Tag'];
                this.greetings = [...this.defaultGreetings];
                this.greeting = 'Moin zusammen';
                const defaultCoords = {};

    this.defaultCoordinates = defaultCoords;      // для сброса
    this.nameToCoordinates = {}; 
                this.travelTimes = {};
                
                this.startPoint = '';
                this.startPointCoords = { lat: null, lng: null };
                this.participantOrders = {};
                this.participants = [];
                this.machineStop = { name: "an der Maschine", time: 20, arrivalTime: "", lat: null, lng: null };
                this.useUhrBei = false;
                this.useSuperscriptTime = false;
                this.sortable = null;

                this.elements = {
                    greetingSelect: document.getElementById('greeting'),
                    editGreetingButton: document.querySelector('.edit-greeting-btn'),
                    startPointSelect: document.getElementById('startPoint'),
                    startPointCoordsButton: document.querySelector('.start-point-coords'),
                    participantsContainer: document.getElementById('participants'),
                    addButton: document.querySelector('.add'),
                    calculateButton: document.querySelector('.calculate'),
                    routeBackButton: document.querySelector('.route-back'),
                    copyButton: document.querySelector('.copy'),
                    clearButton: document.querySelector('.clear'),
                    output: document.getElementById('output'),
                    toast: document.getElementById('toast'),
                    coordsModal: document.getElementById('coordsModal'),
                    modalContent: document.querySelector('.modal-content'),
                    coordsInput: document.getElementById('coordsInput'),
                    coordsLabel: document.getElementById('coordsLabel'),
                    coordsHelp: document.getElementById('coordsHelp'),
                    nameInput: document.getElementById('nameInput'),
                    nameLabel: document.getElementById('nameLabel'),
                    greetingInput: document.getElementById('greetingInput'),
                    greetingLabel: document.getElementById('greetingLabel'),
                    modalTitle: document.getElementById('modalTitle'),
                    saveCoordsButton: document.getElementById('saveCoords'),
                    deleteGreetingButton: document.getElementById('deleteGreeting'),
                    cancelCoordsButton: document.getElementById('cancelCoords'),
                    openMapButton: document.getElementById('openMap')
                };
                this.currentEditIndex = null;
                this.isEditingMachine = false;
                this.isAddingNewName = false;
                this.isAddingNewGreeting = false;
                this.isEditingGreeting = false;
                this.isEditingStartPoint = false;

                this.loadDefaults().then(() => {
  this.loadData();          // восстанавливает пользовательские данные
  this.addEventListeners();
});
            }

            getTravelTime(fromName, toName) {
  if (fromName === toName) return 0;
  const key = `${fromName}-${toName}`;
  const rev = `${toName}-${fromName}`;
  return this.travelTimes[key] ?? this.travelTimes[rev] ?? 5; // 5 – fallback
}


            updateParticipantTimes() {
                let previousPoint = this.startPoint;
                this.participants.forEach(participant => {
                    if (participant.name && !participant.timeManuallyEdited) {
                        participant.time = this.getTravelTime(previousPoint, participant.name);
                    }
                    if (participant.name) previousPoint = participant.name;
                });
            }

            syncCoordinates() {
                this.participants.forEach(p => {
                    const coords = this.nameToCoordinates[p.name];
                    if (coords) { p.lat = coords.lat; p.lng = coords.lng; }
                });
                const startCoords = this.nameToCoordinates[this.startPoint];
                this.startPointCoords = startCoords ? { lat: startCoords.lat, lng: startCoords.lng } : { lat: null, lng: null };
            }

            saveData() {
                localStorage.setItem('fahrzeitRechnerGreeting', this.greeting);
                localStorage.setItem('fahrzeitRechnerGreetings', JSON.stringify(this.greetings));
                localStorage.setItem('fahrzeitRechnerParticipants', JSON.stringify(this.participants));
                localStorage.setItem('fahrzeitRechnerMachineStop', JSON.stringify(this.machineStop));
                localStorage.setItem('fahrzeitRechnerNameToCoordinates', JSON.stringify(this.nameToCoordinates));
                localStorage.setItem('fahrzeitRechnerStartPoint', this.startPoint);
                localStorage.setItem('fahrzeitRechnerUseUhrBei', this.useUhrBei);
                localStorage.setItem('fahrzeitRechnerUseSuperscript', this.useSuperscriptTime);
            }

            resetToDefaults() {
  this.greeting = 'Moin zusammen';
  this.greetings = [...this.defaultGreetings];
  this.startPoint = '';
  this.startPointCoords = { lat: null, lng: null };
  this.participants = [];
  this.nameToCoordinates = { ...this.defaultCoordinates }; 
  this.machineStop = { name: "an der Maschine", time: 20, arrivalTime: "", lat: null, lng: null };
  this.useUhrBei = false;
  this.useSuperscriptTime = false;
  this.saveData();
}


            clearLocalStorage() {
                ['fahrzeitRechnerGreeting', 'fahrzeitRechnerGreetings', 'fahrzeitRechnerParticipants',
                    'fahrzeitRechnerMachineStop', 'fahrzeitRechnerNameToCoordinates', 'fahrzeitRechnerStartPoint',
                    'fahrzeitRechnerUseSuperscript'].forEach(k => localStorage.removeItem(k));
                this.showToast("Данные сброшены.");
                this.resetToDefaults();
                this.elements.output.innerHTML = '';
                this.renderParticipants();
                this.initSortable();
            }

            loadData() {
                try {
                    const saved = {
                        greeting: localStorage.getItem('fahrzeitRechnerGreeting'),
                        greetings: localStorage.getItem('fahrzeitRechnerGreetings'),
                        participants: localStorage.getItem('fahrzeitRechnerParticipants'),
                        machineStop: localStorage.getItem('fahrzeitRechnerMachineStop'),
                        nameToCoordinates: localStorage.getItem('fahrzeitRechnerNameToCoordinates'),
                        startPoint: localStorage.getItem('fahrzeitRechnerStartPoint'),
                        useUhrBei: localStorage.getItem('fahrzeitRechnerUseUhrBei'),
                        useSuperscript: localStorage.getItem('fahrzeitRechnerUseSuperscript')
                    };
                    if (saved.greeting) this.greeting = saved.greeting;
                    if (saved.greetings) try { this.greetings = JSON.parse(saved.greetings); } catch { this.greetings = [...this.defaultGreetings]; }
                    if (saved.participants) try { this.participants = JSON.parse(saved.participants).map(p => ({ ...p, timeManuallyEdited: p.timeManuallyEdited || false })); } catch { this.participants = []; }
                    if (saved.machineStop) try { this.machineStop = JSON.parse(saved.machineStop); } catch { this.machineStop = { name: "an der Maschine", time: 20, arrivalTime: "", lat: null, lng: null }; }
                    if (saved.nameToCoordinates) try { this.nameToCoordinates = JSON.parse(saved.nameToCoordinates); } catch { /* use default */ }
                    if (saved.startPoint) {
                        this.startPoint = saved.startPoint;
                        const startCoords = this.nameToCoordinates[this.startPoint];
                        this.startPointCoords = startCoords ? { lat: startCoords.lat, lng: startCoords.lng } : { lat: null, lng: null };
                    }
                    if (saved.useUhrBei !== null) this.useUhrBei = saved.useUhrBei === 'true';
                    if (saved.useSuperscript !== null) this.useSuperscriptTime = saved.useSuperscript === 'true';
                } catch {
                    this.resetToDefaults();
                }
                this.updateStartPoint(this.startPoint);
            }
            
            // Загружаем настройки при старте из api/default.js
            async loadDefaults() {
  try {
    const res = await fetch('/api/defaults');
    const data = await res.json();

    this.nameToCoordinates = data.names;
    this.participantOrders = data.participantOrders;
    this.travelTimes = data.travelTimes;

    // если в localStorage уже были сохранённые координаты — подмешиваем
    const saved = localStorage.getItem('fahrzeitRechnerNameToCoordinates');
    if (saved) {
      try {
        const parsed = JSON.parse(saved);
        Object.assign(this.nameToCoordinates, parsed);
      } catch {}
    }

    this.syncCoordinates();
    this.renderParticipants();
    this.initSortable();
    this.calculate();
  } catch (err) {
    console.error('Не удалось загрузить defaults', err);
    // fallback: оставляем пустые объекты, чтобы страница не падала
  }
}

            

            addEventListeners() {
                this.elements.greetingSelect.addEventListener('change', e => {
                    if (e.target.value === 'add-new-greeting') this.openGreetingModal(true);
                    else { this.greeting = e.target.value; this.saveData(); this.calculate(); }
                });
                this.elements.editGreetingButton.addEventListener('click', () => this.openGreetingModal(false));
                this.elements.startPointSelect.addEventListener('change', e => this.updateStartPoint(e.target.value));
                this.elements.startPointCoordsButton.addEventListener('click', () => this.openCoordsModal(null, false, false, true));
                this.elements.addButton.addEventListener('click', () => this.addParticipant());
                this.elements.calculateButton.addEventListener('click', () => this.openGoogleMaps());
                this.elements.routeBackButton.addEventListener('click', () => this.openGoogleMaps(true));
                this.elements.copyButton.addEventListener('click', () => this.copyResult());
                this.elements.clearButton.addEventListener('click', () => this.clearLocalStorage());
                this.elements.saveCoordsButton.addEventListener('click', () => this.saveCoordinates());
                this.elements.deleteGreetingButton.addEventListener('click', () => this.deleteGreeting());
                this.elements.cancelCoordsButton.addEventListener('click', () => this.closeModal());
                this.elements.openMapButton.addEventListener('click', () => this.openMapForSelection());
            }

            updateStartPoint(value) {
                if (value === 'add-new') {
                    this.openCoordsModal(null, false, true, true);
                } else {
                    this.startPoint = value;
                    const startCoords = this.nameToCoordinates[value];
                    this.startPointCoords = startCoords ? { lat: startCoords.lat, lng: startCoords.lng } : { lat: null, lng: null };
                    const order = this.participantOrders[value] || [];
                    this.participants = order.map((name, idx) => {
                        const coords = this.nameToCoordinates[name] || { lat: null, lng: null };
                        const prev = idx === 0 ? this.startPoint : order[idx - 1];
                        return {
                            name,
                            time: this.getTravelTime(prev, name),
                            lat: coords.lat,
                            lng: coords.lng,
                            timeManuallyEdited: false
                        };
                    });
                    this.updateParticipantTimes();
                    this.saveData();
                    this.renderParticipants();
                    this.initSortable();
                    this.calculate();
                }
            }

            renderParticipants() {
                const container = this.elements.participantsContainer;
                container.innerHTML = '';
                this.elements.greetingSelect.innerHTML = this.greetings.map(g => `<option value="${g}" ${this.greeting === g ? 'selected' : ''}>${g}</option>`).join('') + '<option value="add-new-greeting">Добавить новое приветствие</option>';
                const nameOptions = Object.keys(this.nameToCoordinates).map(name => `<option value="${name}" ${this.startPoint === name ? 'selected' : ''}>${name}</option>`).join('');
                this.elements.startPointSelect.innerHTML = `
            <option value="" ${!this.startPoint ? 'selected' : ''}>Выберите начальную точку</option>
            ${nameOptions}
            <option value="add-new">Добавить новое имя</option>
        `;
                const noCoordsSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="rgb(209,43,47)"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>`;
                const hasCoordsSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="rgb(68,178,229)"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>`;
                this.elements.startPointCoordsButton.innerHTML = (this.startPointCoords.lat && this.startPointCoords.lng) ? hasCoordsSvg : noCoordsSvg;

                const validNames = this.participants.map(p => p.name).filter(n => n);
                if (this.startPoint && validNames.includes(this.startPoint)) {
                    this.showToast(`Начальная точка "${this.startPoint}" не может совпадать с именем участника.`);
                    this.startPoint = ''; this.startPointCoords = { lat: null, lng: null };
                    this.participants = []; this.saveData();
                }

                this.participants.forEach((p, i) => {
                    const div = document.createElement('div');
                    div.className = 'participant';
                    div.setAttribute('data-index', i);
                    const participantNameOptions = Object.keys(this.nameToCoordinates).filter(n => n !== this.startPoint)
                        .map(n => `<option value="${n}" ${p.name === n ? 'selected' : ''}>${n}</option>`).join('');
                    const coordsSvg = (p.lat && p.lng) ? hasCoordsSvg : noCoordsSvg;
                    div.innerHTML = `
                <select data-index="${i}" data-type="participant-name" aria-label="Имя участника">
                    <option value="" ${!p.name ? 'selected' : ''}>Выберите имя</option>
                    ${participantNameOptions}
                    <option value="add-new">Добавить новое имя</option>
                </select>
                <button class="coords-icon" data-index="${i}" data-type="participant-coords" aria-label="Редактировать координаты участника">${coordsSvg}</button>
                <input type="number" value="${p.time}" min="1" max="60" data-index="${i}" data-type="participant-time" aria-label="Время поездки к участнику в минутах"/>
                <div class="right-section">
                    <span class="material-symbols-outlined" aria-label="Переместить участника">
                        <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 -960 960 960" width="24" fill="#e3e3e3"><path d="M320-440v-287L217-624l-57-56 200-200 200 200-57 56-103-103v287h-80ZM600-80 400-280l57-56 103 103v-287h80v287l103-103 57 56L600-80Z"/></svg>
                    </span>
                    <button class="remove-btn" data-index="${i}" aria-label="Удалить участника">✖</button>
                </div>
            `;
                    container.appendChild(div);
                    div.querySelector('[data-type="participant-name"]').addEventListener('change', e => this.updateName(i, e.target.value));
                    div.querySelector('[data-type="participant-time"]').addEventListener('change', e => this.updateTime(i, e.target.value));
                    div.querySelector('[data-type="participant-coords"]').addEventListener('click', () => this.openCoordsModal(i));
                    div.querySelector('.remove-btn').addEventListener('click', () => this.removeParticipant(i));
                });

                const machineDiv = document.createElement('div');
                machineDiv.className = 'participant machine';
                const machineCoordsSvg = (this.machineStop.lat && this.machineStop.lng) ? hasCoordsSvg : noCoordsSvg;

                machineDiv.innerHTML = `
    <input type="text" value="${this.machineStop.name}" data-type="machine-name" aria-label="Название остановки машины"/>
    <button class="coords-icon" data-type="machine-coords" aria-label="Редактировать координаты машины">${machineCoordsSvg}</button>
    <input type="number" value="${this.machineStop.time}" min="1" max="60" data-type="machine-time" aria-label="Время на остановке машины в минутах"/>
    <div class="right-section">
        ${this.machineStop.arrivalTime
                        ? `<div class="arrival-time" tabindex="0" role="button" aria-label="Изменить время прибытия">${this.machineStop.arrivalTime}</div><button class="time-remove" aria-label="Очистить время прибытия">✖</button>`
                        : '<button class="time-icon" aria-label="Установить время прибытия">🕒</button>'
                    }
    </div>
`;

                container.appendChild(machineDiv);
                machineDiv.querySelector('[data-type="machine-name"]').addEventListener('change', e => this.updateMachineName(e.target.value));
                machineDiv.querySelector('[data-type="machine-time"]').addEventListener('change', e => this.updateMachineTime(e.target.value));
                machineDiv.querySelector('[data-type="machine-coords"]').addEventListener('click', () => this.openCoordsModal(null, true));

                container.appendChild(machineDiv);

                // Добавляем новый контейнер для чекбоксов
                const checkboxContainer = document.createElement('div');
                checkboxContainer.className = 'checkbox-container';
                checkboxContainer.innerHTML = `
    <label>
        <input type="checkbox" id="useUhrBei" ${this.useUhrBei ? 'checked' : ''}> um...Uhr bei
    </label>
    <label>
        <input type="checkbox" id="useSuperscriptTime" ${this.useSuperscriptTime ? 'checked' : ''}> X²
    </label>
`;
                container.appendChild(checkboxContainer);

                // Обработчики событий для чекбоксов
                const uhrBeiCheckbox = checkboxContainer.querySelector('#useUhrBei');
                uhrBeiCheckbox.addEventListener('change', () => {
                    this.useUhrBei = uhrBeiCheckbox.checked;
                    this.saveData();
                    this.calculate();
                });
                const superscriptCheckbox = checkboxContainer.querySelector('#useSuperscriptTime');
                superscriptCheckbox.addEventListener('change', () => {
                    this.useSuperscriptTime = superscriptCheckbox.checked;
                    this.saveData();
                    this.calculate();
                });

                const timeControl = machineDiv.querySelector('.time-icon') || machineDiv.querySelector('.arrival-time');
                timeControl.addEventListener('click', () => this.startTimeEdit());
                timeControl.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        this.startTimeEdit();
                    }
                });
                const timeRemoveBtn = machineDiv.querySelector('.time-remove');
                if (timeRemoveBtn) timeRemoveBtn.addEventListener('click', () => this.clearArrivalTime());
                this.saveData();
                if (this.machineStop.arrivalTime) this.calculate(); else this.elements.output.innerHTML = '';
            }

            async parseCoordinates(raw) {
                const s = raw.trim();
                if (!s) { this.showToast("Пожалуйста, введите данные."); return null; }
                
                
                // 1. «51,123456, 7,123456» — дробь через ЗАПЯТУЮ
if (/^-?\d{1,2},\d+\s*,\s*-?\d{1,3},\d+$/.test(s)) {
  const parts = s.split(',').map(p => p.trim());
  const lat = parseFloat(parts[0] + '.' + parts[1]);
  const lng = parseFloat(parts[2] + '.' + parts[3]);
  if (Math.abs(lat) <= 90 && Math.abs(lng) <= 180) return { lat, lng };
}

// 2. «51.123456, 7.123456» — дробь через ТОЧКУ 
if (/^-?\d{1,2}(?:\.\d+)?\s*,\s*-?\d{1,3}(?:\.\d+)?$/.test(s)) {
  const [l, ln] = s.split(',').map(Number);
  if (Math.abs(l) <= 90 && Math.abs(ln) <= 180) return { lat: l, lng: ln };
}

                const m1 = s.match(/@(-?\d+\.\d+),(-?\d+\.\d+)/) || s.match(/ll=(-?\d+\.\d+),(-?\d+\.\d+)/) || s.match(/place\/[^\/]+\/(-?\d+\.\d+),(-?\d+\.\d+)/);
                if (m1) {
                    const lat = parseFloat(m1[1]), lng = parseFloat(m1[2]);
                    if (Math.abs(lat) <= 90 && Math.abs(lng) <= 180) return { lat, lng };
                }
                const dms = [...s.matchAll(/(\d{1,3})°(\d{1,2})'(\d{1,2}(?:\.\d+)?)"?\s*([NSEW])/gi)];
                if (dms.length === 2) {
                    try {
                        const toDec = ([, d, mi, s, dir]) => {
                            let dec = +d + mi / 60 + s / 3600;
                            if (/S|W/i.test(dir)) dec = -dec;
                            return dec;
                        };
                        const lat = toDec(dms[0]), lng = toDec(dms[1]);
                        if (Math.abs(lat) <= 90 && Math.abs(lng) <= 180) return { lat, lng };
                    } catch { }
                }
                if (/^https?:\/\/(?:[^/]*\.)?goo\.gl\/|https?:\/\/maps\.app\.goo\.gl\/|https?:\/\/(?:www\.)?googleusercontent\.com\/maps\.google\.com\//i.test(s)) {

                    try {
                        const url = await this.expand(s);
                        let coords = this.parseCoords(url);
                        if (!coords) coords = await this.coordsFromHTML(url);
                        if (!coords) { this.showToast("Не удалось извлечь координаты из ссылки."); return null; }
                        return coords;
                    } catch {
                        this.showToast("Ошибка при обработке сокращённой ссылки.");
                        return null;
                    }
                }
                if (!/^https?:\/\//.test(s)) {
                    const coords = this.parseCoords(s);
                    if (coords) return coords;
                }
                if (/^https?:\/\//.test(s)) {
                    try {
                        const coords = await this.coordsFromHTML(s);
                        if (coords) return coords;
                    } catch {
                        this.showToast("Не удалось извлечь координаты из ссылки.");
                        return null;
                    }
                }
                this.showToast("Пожалуйста, введите корректные координаты или URL Google Карт.");
                return null;
            }

            async expand(shortUrl) {
                const api = 'https://r.jina.ai/' + shortUrl.replace(/^https?:\/\//, '');
                const response = await fetch(api);
                if (!response.ok) throw new Error('Не удалось раскрыть ссылку');
                const raw = await response.text();
                try {
                    const json = JSON.parse(raw);
                    if (json.resolved_url) return json.resolved_url;
                } catch { }
                const match = raw.match(/https?:\/\/[^\s"']+/);
                if (match) return match[0];
                throw new Error('Сервис не вернул URL');
            }

            parseCoords(str) {
                let m = str.match(/([-+]?\d{1,3}\.\d+)[ ,]+([-+]?\d{1,3}\.\d+)/);
                if (m) {
                    const lat = +m[1], lng = +m[2];
                    if (Math.abs(lat) <= 90 && Math.abs(lng) <= 180) return { lat, lng };
                }
                m = str.match(/@([-.\d]+),([-.\d]+),/);
                if (m) {
                    const lat = +m[1], lng = +m[2];
                    if (Math.abs(lat) <= 90 && Math.abs(lng) <= 180) return { lat, lng };
                }
                m = str.match(/\/place\/([-.\d]+),([-.\d]+)/);
                if (m) {
                    const lat = +m[1], lng = +m[2];
                    if (Math.abs(lat) <= 90 && Math.abs(lng) <= 180) return { lat, lng };
                }
                m = str.match(/(?:dest|query|center)=([-.\d]+),([-.\d]+)/);
                if (m) {
                    const lat = +m[1], lng = +m[2];
                    if (Math.abs(lat) <= 90 && Math.abs(lng) <= 180) return { lat, lng };
                }
                return null;
            }

            async coordsFromHTML(page) {
                const api = 'https://r.jina.ai/' + page.replace(/^https?:\/\//, '');
                const response = await fetch(api);
                if (!response.ok) return null;
                const text = await response.text();
                let m = text.match(/"lat"\s*:\s*([-.\d]+)\s*,\s*"lng"\s*:\s*([-.\d]+)/);
                if (m) {
                    const lat = +m[1], lng = +m[2];
                    if (Math.abs(lat) <= 90 && Math.abs(lng) <= 180) return { lat, lng };
                }
                m = text.match(/https?:\/\/[^"' ]+\?q=([-.\d]+),([-.\d]+)/);
                if (m) {
                    const lat = +m[1], lng = +m[2];
                    if (Math.abs(lat) <= 90 && Math.abs(lng) <= 180) return { lat, lng };
                }
                m = text.match(/([-+]?\d{1,3}\.\d{4,}),\s*([-+]?\d{1,3}\.\d{4,})/);
                if (m) {
                    const lat = +m[1], lng = +m[2];
                    if (Math.abs(lat) <= 90 && Math.abs(lng) <= 180) return { lat, lng };
                }
                return null;
            }

            openCoordsModal(index, isMachine = false, isAddingNewName = false, isEditingStartPoint = false) {
                this.currentEditIndex = index;
                this.isEditingMachine = isMachine;
                this.isAddingNewName = isAddingNewName;
                this.isEditingStartPoint = isEditingStartPoint;
                this.isAddingNewGreeting = false;
                this.isEditingGreeting = false;
                const modal = this.elements.coordsModal;
                const modalContent = this.elements.modalContent;
                const coordsInput = this.elements.coordsInput;
                const coordsLabel = this.elements.coordsLabel;
                const coordsHelp = this.elements.coordsHelp;
                const nameInput = this.elements.nameInput;
                const nameLabel = this.elements.nameLabel;
                const greetingInput = this.elements.greetingInput;
                const greetingLabel = this.elements.greetingLabel;
                const modalTitle = this.elements.modalTitle;
                const openMapButton = this.elements.openMapButton;
                const deleteGreetingButton = this.elements.deleteGreetingButton;

                modalContent.classList.toggle('add-new-name', isAddingNewName);
                modalTitle.textContent = isAddingNewName ? 'Добавить новое имя' :
                    isEditingStartPoint ? 'Редактировать координаты начальной точки' :
                        isMachine ? 'Редактировать координаты машины' : 'Редактировать координаты';

                [nameLabel, nameInput, greetingLabel, greetingInput, deleteGreetingButton].forEach(el => el.style.display = 'none');
                [coordsLabel, coordsHelp, coordsInput, openMapButton].forEach(el => el.style.display = 'block');

                if (isAddingNewName) {
                    nameLabel.style.display = 'block';
                    nameInput.style.display = 'block';
                    nameInput.value = '';
                    coordsInput.value = '';
                } else if (isEditingStartPoint) {
                    coordsInput.value = this.startPointCoords.lat && this.startPointCoords.lng ? `${this.startPointCoords.lat},${this.startPointCoords.lng}` : '';
                } else if (isMachine) {
                    coordsInput.value = this.machineStop.lat && this.machineStop.lng ? `${this.machineStop.lat},${this.machineStop.lng}` : '';
                } else {
                    const participant = this.participants[index];
                    coordsInput.value = participant.lat && participant.lng ? `${participant.lat},${participant.lng}` : '';
                }
                modal.style.display = 'flex';
                (isAddingNewName ? nameInput : coordsInput).focus();
            }

            openGreetingModal(isAddingNewGreeting) {
                this.isAddingNewGreeting = isAddingNewGreeting;
                this.isEditingGreeting = !isAddingNewGreeting;
                this.isAddingNewName = false;
                this.isEditingMachine = false;
                this.isEditingStartPoint = false;
                const modal = this.elements.coordsModal;
                const modalContent = this.elements.modalContent;
                modalContent.classList.remove('add-new-name');
                this.elements.modalTitle.textContent = isAddingNewGreeting ? 'Добавить новое приветствие' : 'Редактировать приветствие';
                ['coordsLabel', 'coordsHelp', 'coordsInput', 'openMapButton', 'nameLabel', 'nameInput'].forEach(el => this.elements[el].style.display = 'none');
                this.elements.greetingLabel.style.display = 'block';
                this.elements.greetingInput.style.display = 'block';
                this.elements.greetingInput.value = this.greeting;
                this.elements.deleteGreetingButton.style.display = this.defaultGreetings.includes(this.greeting) ? 'none' : 'inline-block';
                modal.style.display = 'flex';
                this.elements.greetingInput.focus();
            }

            async saveCoordinates() {
                const saveButton = this.elements.saveCoordsButton;
                const original = saveButton.textContent;
                saveButton.textContent = 'Загрузка...';
                saveButton.disabled = true;
                try {
                    if (this.isAddingNewGreeting || this.isEditingGreeting) {
                        const newGreeting = this.elements.greetingInput.value.trim();
                        if (!newGreeting) { this.showToast("Введите приветствие."); return; }
                        if (this.isAddingNewGreeting && this.greetings.includes(newGreeting)) { this.showToast("Приветствие уже существует."); return; }
                        if (this.isEditingGreeting) {
                            const old = this.greeting;
                            const idx = this.greetings.indexOf(old);
                            if (idx !== -1 && !this.defaultGreetings.includes(old)) this.greetings[idx] = newGreeting;
                            this.greeting = newGreeting;
                        } else if (this.isAddingNewGreeting) {
                            this.greetings.push(newGreeting);
                            this.greeting = newGreeting;
                        }
                        this.closeModal(); this.saveData(); this.renderParticipants(); this.calculate();
                    } else {
                        const raw = this.elements.coordsInput.value.trim();
                        const coords = await this.parseCoordinates(raw);
                        if (!coords) return;
                        if (this.isAddingNewName) {
                            const name = this.elements.nameInput.value.trim();
                            if (!name) { this.showToast("Введите имя."); return; }
                            if (this.nameToCoordinates[name]) { this.showToast("Имя уже существует."); return; }
                            this.nameToCoordinates[name] = { lat: coords.lat, lng: coords.lng };
                            if (this.isEditingStartPoint) {
                                this.startPoint = name;
                                this.startPointCoords = { lat: coords.lat, lng: coords.lng };
                                this.participants = [];
                            } else {
                                this.participants[this.currentEditIndex].name = name;
                                this.participants[this.currentEditIndex].lat = coords.lat;
                                this.participants[this.currentEditIndex].lng = coords.lng;
                                this.participants[this.currentEditIndex].timeManuallyEdited = false;
                            }
                            this.updateParticipantTimes();
                        } else if (this.isEditingMachine) {
                            this.machineStop.lat = coords.lat; this.machineStop.lng = coords.lng;
                        } else if (this.isEditingStartPoint) {
                            this.startPointCoords = { lat: coords.lat, lng: coords.lng };
                            this.updateParticipantTimes();
                        } else {
                            this.participants[this.currentEditIndex].lat = coords.lat;
                            this.participants[this.currentEditIndex].lng = coords.lng;
                            this.participants[this.currentEditIndex].timeManuallyEdited = false;
                            this.updateParticipantTimes();
                        }
                        this.closeModal(); this.saveData(); this.renderParticipants(); this.initSortable(); this.calculate();
                    }
                } finally {
                    saveButton.textContent = original;
                    saveButton.disabled = false;
                }
            }

            deleteGreeting() {
                if (!this.defaultGreetings.includes(this.greeting)) {
                    this.greetings = this.greetings.filter(g => g !== this.greeting);
                    this.greeting = this.defaultGreetings[0];
                    this.closeModal(); this.saveData(); this.renderParticipants(); this.calculate();
                }
            }

            closeModal() {
                this.elements.coordsModal.style.display = 'none';
                this.isAddingNewName = this.isEditingMachine = this.isAddingNewGreeting = this.isEditingGreeting = this.isEditingStartPoint = false;
                this.currentEditIndex = null;
            }

            openMapForSelection() {
                const coords = this.elements.coordsInput.value.trim();
                let url = 'https://www.google.com/maps';
                if (coords) {
                    const parsed = this.parseCoords(coords);
                    if (parsed) url += `/place/${parsed.lat},${parsed.lng}`;
                    else url += `/search/${encodeURIComponent(coords)}`;
                }
                window.open(url, '_blank');
            }

            addParticipant() {
                this.participants.push({ name: '', time: 5, lat: null, lng: null, timeManuallyEdited: false });
                this.updateParticipantTimes();
                this.saveData();
                this.renderParticipants();
                this.initSortable();
                this.calculate();
            }

            updateName(index, value) {
                if (value === 'add-new') this.openCoordsModal(index, false, true);
                else {
                    this.participants[index].name = value;
                    const coords = this.nameToCoordinates[value] || { lat: null, lng: null };
                    this.participants[index].lat = coords.lat;
                    this.participants[index].lng = coords.lng;
                    this.participants[index].timeManuallyEdited = false;
                    this.updateParticipantTimes();
                    this.saveData();
                    this.renderParticipants();
                    this.initSortable();
                    this.calculate();
                }
            }

            updateTime(index, value) {
                const time = parseInt(value) || 5;
                this.participants[index].time = Math.max(1, Math.min(60, time));
                this.participants[index].timeManuallyEdited = true;
                this.saveData();
                this.renderParticipants();
                this.calculate();
            }

            updateMachineName(value) {
                this.machineStop.name = value.trim() || 'an der Maschine';
                this.saveData();
                this.calculate();
            }

            updateMachineTime(value) {
                const time = parseInt(value) || 20;
                this.machineStop.time = Math.max(1, Math.min(60, time));
                this.saveData();
                this.calculate();
            }

            clearArrivalTime() {
                this.machineStop.arrivalTime = "";
                this.saveData();
                this.elements.output.innerHTML = '';
                this.renderParticipants();
            }

            startTimeEdit() {
                const container = document.querySelector('.machine .right-section');
                const existingInput = container.querySelector('input[type="time"]');
                if (existingInput) existingInput.remove();

                const input = document.createElement('input');
                input.type = 'time';
                input.style.width = '100px';
                input.style.padding = 'var(--small-spacing)';
                input.style.border = '1px solid #ddd';
                input.style.borderRadius = '4px';
                input.style.fontSize = '1em';
                input.value = this.machineStop.arrivalTime || '';
                const timeControl = container.querySelector('.time-icon') || container.querySelector('.arrival-time');
                container.insertBefore(input, timeControl);
                timeControl.style.display = 'none';

                const saveTime = () => {
                    this.machineStop.arrivalTime = input.value;
                    container.removeChild(input);
                    timeControl.style.display = 'flex';
                    this.renderParticipants();
                    this.initSortable();
                    this.calculate();
                    input.removeEventListener('change', saveTime);
                    input.removeEventListener('blur', saveTime);
                };
                input.addEventListener('change', saveTime);
                input.addEventListener('blur', () => setTimeout(saveTime, 50));
                input.focus();
                try { input.showPicker(); } catch { }
            }

            initSortable() {
                if (this.sortable) this.sortable.destroy();
                this.sortable = new Sortable(this.elements.participantsContainer, {
                    handle: '.material-symbols-outlined',
                    animation: 150,
                    onEnd: evt => {
                        if (evt.oldIndex !== evt.newIndex) {
                            const [moved] = this.participants.splice(evt.oldIndex, 1);
                            this.participants.splice(evt.newIndex, 0, moved);
                            this.updateParticipantTimes();
                            this.saveData();
                            this.renderParticipants();
                            this.calculate();
                        }
                    }
                });
            }

            showToast(message) {
                this.elements.toast.textContent = message;
                this.elements.toast.classList.add('show');
                setTimeout(() => this.elements.toast.classList.remove('show'), 3000);
            }

            formatTime(date) {
                if (this.useSuperscriptTime) {
                    const hours = date.getHours().toString().padStart(2, '0');
                    const minutes = date.getMinutes().toString().padStart(2, '0');
                    const superscriptDigits = ['⁰', '¹', '²', '³', '⁴', '⁵', '⁶', '⁷', '⁸', '⁹'];
                    const superscriptMinutes = minutes.split('').map(d => superscriptDigits[parseInt(d)]).join('');
                    return `${hours}${superscriptMinutes}`;
                }
                return date.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
            }

            calculate(){
  if(!this.machineStop.arrivalTime){this.elements.output.innerHTML='';return}
  let out=`${this.greeting},\n`;

  const valid=this.participants.filter(p=>p.name);
  const total=valid.reduce((s,p)=>s+p.time,0)+this.machineStop.time;

  // 1. ВЫЧИСЛЯЕМ ВРЕМЯ СТАРТА
  const startTime=new Date(`2025-07-25T${this.machineStop.arrivalTime}:00`);
  startTime.setMinutes(startTime.getMinutes()-total);

  // 2. ФОРМИРУЕМ ВЫВОД
  out+=this.useUhrBei
    ? `um ${this.formatTime(startTime)} Uhr geht's los\n`
    : `${this.formatTime(startTime)}  geht's los\n`;

  let current=new Date(startTime);
  valid.forEach(p=>{
    current.setMinutes(current.getMinutes()+p.time);
    out+=this.useUhrBei
      ? `um ${this.formatTime(current)} Uhr bei ${p.name}\n`
      : `${this.formatTime(current)}  ${p.name}\n`;
  });

  // Время прибытия к машине
  const machineTime=new Date(`2025-07-25T${this.machineStop.arrivalTime}:00`);
  out+=this.useUhrBei
    ? `um ${this.formatTime(machineTime)} Uhr ${this.machineStop.name}\n`
    : `${this.formatTime(machineTime)}  ${this.machineStop.name}\n`;

  this.elements.output.innerHTML=out;
}


            openGoogleMaps(returnTrip = false) {
                const validParticipants = this.participants.filter(p => p.name && p.lat && p.lng);
                if (!this.startPointCoords.lat || !this.startPointCoords.lng || validParticipants.length === 0) {
                    this.showToast("Добавьте начальную точку и хотя бы одного участника с координатами.");
                    return;
                }
                let url = 'https://www.google.com/maps/dir/';
                if (!returnTrip) {
                    url += `${this.startPointCoords.lat},${this.startPointCoords.lng}/`;
                    validParticipants.forEach(p => url += `${p.lat},${p.lng}/`);
                    if (this.machineStop.lat && this.machineStop.lng) url += `${this.machineStop.lat},${this.machineStop.lng}`;
                } else {
                    if (this.machineStop.lat && this.machineStop.lng) url += `${this.machineStop.lat},${this.machineStop.lng}/`;
                    for (let i = validParticipants.length - 1; i >= 0; i--) url += `${validParticipants[i].lat},${validParticipants[i].lng}/`;
                    url += `${this.startPointCoords.lat},${this.startPointCoords.lng}`;
                }
                window.open(url, '_blank');
            }

            copyResult() {
                const text = this.elements.output.textContent.trim();
                if (!text) {
                    this.showToast("Нечего копировать — сначала рассчитайте маршрут.");
                    return;
                }
                navigator.clipboard.writeText(text)
                    .then(() => this.showToast("Результат скопирован в буфер обмена!"))
                    .catch(() => this.showToast("Не удалось скопировать — разрешите доступ к буферу обмена."));
            }

            removeParticipant(index) {
                this.participants.splice(index, 1);
                this.updateParticipantTimes();
                this.saveData();
                this.renderParticipants();
                this.initSortable();
                this.calculate();
            }
        }

        document.addEventListener('DOMContentLoaded', () => new FahrzeitRechner());
    </script>
</body>

</html>